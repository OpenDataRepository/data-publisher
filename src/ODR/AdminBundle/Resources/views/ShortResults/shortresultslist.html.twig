{% spaceless %}

{% set datatype = datatype_array[initial_datatype_id] %}
{% set theme = theme_array[datatype.id] %}

{% set can_edit_datarecord = false %}
{% set is_datatype_admin = false %}

{% if user_permissions[ datatype.id ] is defined and user_permissions[ datatype.id ][ 'dr_edit' ] is defined %}
    {% set can_edit_datarecord = true %}
{% endif %}
{% if user_permissions[ datatype.id ] is defined and user_permissions[ datatype.id ][ 'dt_admin' ] is defined %}
    {% set is_datatype_admin = true %}
{% endif %}

{% set user_role = '' %}
{% if user != 'anon.' %}
    {% for role in user.getroles %}
        {% if role == 'ROLE_ADMIN' %}
            {% set user_role = 'ROLE_ADMIN' %}
        {% endif %}
    {% endfor %}
{% endif %}


<div class="ODRFormWrap">
    <div class="header">
    {% if datatype != null %}
        {% if target == "results" %}
            <h2>Display Records - {{ datatype.dataTypeMeta.shortName }}</h2>
        {% else %}
            <h2>Edit Records - {{ datatype.dataTypeMeta.shortName }}</h2>
        {% endif %}
    {% endif %}
    </div>

{% if count > 0 %}
    <div class="ODRShortResultWrapper">
        {{ pagination_html | raw }}

        {# Page/View Options #}
        {% include 'ODRAdminBundle:Default:view_manager.html.twig' with {
            'datatype': datatype,
            'theme': theme,
            'page_type': 'search_results',
            'search_key': search_key,
        } %}

        {% include 'ODRAdminBundle:ShortResults:shortresults_ajax.html.twig' with {
            'datatype_array': datatype_array,
            'datarecord_array': datarecord_array,
            'theme_array': theme_array,

            'initial_datatype_id': initial_datatype_id,
            'offset': offset,
            'can_edit_datarecord': can_edit_datarecord,

            'target': target,
        } %}

        {% include 'ODRAdminBundle:Default:file_download_dialog.html.twig' %}
    </div>
{% elseif logged_in %}
    No Datarecords found
{% else %}
    No Datarecords found...try logging in.
{% endif %}

</div><!-- End of .ODRFormWrap -->

{% if target == 'results' and user_role == 'ROLE_ADMIN' and count > 0 %}
<div class="ODRExportButtons Cursor">
    <div style="float:left;">
        {% if can_edit_datarecord or is_datatype_admin %}
            <button id="ODRMassEdit" class="pure-button" type="button" onclick="doMassEdit();">Mass Edit all these datarecords</button>
        {% endif %}
        <button id="ODRCSVExport" class="pure-button" type="button" onclick="doCSVExport();">Mass Export these datarecords into CSV file</button>
    </div>

    {% if use_jupyterhub %}
    <div style="float:right;">
        <span id="jupyterhub_app_list" style="padding-right: 10px;"></span>

        <form target="_blank" action="{{ path('odr_jupyterhub_export') }}" method="post" style="display: inline;">
            <input type="hidden" name="datatype_id" value="{{ datatype.id }}" />
            <input type="hidden" name="search_key" value="{{ search_key }}" />
            <input type="hidden" name="app_id" id="jupyterhub_app_id" />

            <button id="ODRRunApp" type="submit" class="pure-button">Run this Jupyterhub app on these search results</button>
        </form>
    </div>
    {% endif %}
</div>
{% endif %}

<script>

    $(function() {
        $(".MenuDesignArea").remove();

        var prevent_scroll = false;
        ShortResults_initPage(prevent_scroll);

        // Need a tab id in html5 sessionStorage if one doesn't exist
        if ( !window.sessionStorage.getItem('odr_tab_id') )
            window.sessionStorage.setItem('odr_tab_id', '{{ odr_tab_id }}');

{% if user_role == 'ROLE_ADMIN' and count > 0 and use_jupyterhub %}
        // Get the app list to display on the page
        $.ajax({
            cache: false,
            type: 'GET',
            url: "{{ path('odr_jupyterhub_app_list', {'datatype_id': datatype.id}) }}",
            dataType: "json",
            success: function(data, textStatus, jqXHR) {
                if ( parseInt(jqXHR.status) === 200 ) {
                    $("#jupyterhub_app_list").html(data.html);

                    $("#jupyterhub_app_selector").unbind('change').change(function() {
                        var selected = $(this).val();
                        $("#jupyterhub_app_id").val(selected);
                    });

                    // Store the value of the first option in the form
                    $("#jupyterhub_app_id").val( $("#jupyterhub_app_selector option:first").val() );
                }
            }
        });
{% endif %}

{% if display_theme_warning %}
        $("#ODRMainMenu").overhang({
            type: "warn",
            message: "The originally requested layout is marked as private.  The database's default layout is being displayed instead.",
            closeConfirm: true
        });
{% endif %}
    });


    function ShortResults_initPage(prevent_scroll) {
        // Resize all elements dependent on window size
        $(window).unbind('resize').resize(function() {
            WindowResizeInterval = window.clearInterval(WindowResizeInterval);
            WindowResizeInterval = window.setInterval("onWindowResize()", 500);
        });

        // Resize everything prior to divs being hidden
        onWindowResize();

        // Set up image galleries
        setupImageGalleries();

        // Hide divs for accordion purposes
        setupAccordions();

        $(".ODRFileDownloadProgress").hide();

        $("a.ODRFileDownload").unbind('click').click(function(event) {
            // Grab necessary attributes
            var file_id = $(this).attr('rel');

            handleFileDownload(event, file_id);    // defined in Default::file_handling.html.twig
        });

        {% if scroll_target != '' %}
        if (!prevent_scroll) {
            var target = '#ShortResults_' + {{ scroll_target }};
            if ( $(target) !== null && $(target) !== undefined && $(target).offset() !== null ) {
                $('html, body').animate({
                    scrollTop: $(target).offset().top
                }, 500);
            }
        }
        {% endif %}

    }

{% if target == 'results' and count > 0 and user_role == 'ROLE_ADMIN' %}
    {% if can_edit_datarecord or is_datatype_admin %}
    function doMassEdit() {
        var url = '{{ path('odr_mass_edit_render', { 'search_theme_id': search_theme_id, 'datatype_id': datatype.id, 'search_key': search_key, 'offset': offset }) }}';
        UpdateURL(url);
    }
    {% endif %}

    function doCSVExport() {
        var url = '{{ path('odr_csv_export_render', { 'search_theme_id': search_theme_id, 'datatype_id': datatype.id, 'search_key': search_key, 'offset': offset }) }}';
        UpdateURL(url);
    }
{% endif %}
</script>

{% import "ODRAdminBundle:Default:load_datarecord_js.html.twig" as js %}
{{ js.write(target, search_theme_id, search_key, offset) }}

{% endspaceless %}
