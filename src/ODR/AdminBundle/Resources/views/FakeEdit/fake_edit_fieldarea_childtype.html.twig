{% spaceless %}

{% set parent_datatype_id = parent_datarecord.dataType.id %}
{% set childtype = datatype_array[target_datatype_id] %}
{% set childtype_name = childtype.dataTypeMeta.shortName %}

{% set child_datarecord_count = 0 %}
{% for dr_id, dr in datarecord_array %}
    {% set child_datarecord_count = child_datarecord_count + 1 %}
{% endfor %}

{% set can_edit_parent_record = false %}
{% if datatype_permissions[ parent_datatype_id ] is defined
    and datatype_permissions[ parent_datatype_id ][ 'dr_edit' ] is defined %}
    {% set can_edit_parent_record = true %}
{% endif %}

{% set can_add_child_record = false %}
{% if datatype_permissions[ childtype.id ] is defined
    and datatype_permissions[ childtype.id ][ 'dr_add' ] is defined %}
    {% set can_add_child_record = true %}
{% endif %}
{% set can_edit_child_record = false %}
{% if datatype_permissions[ childtype.id ] is defined
    and datatype_permissions[ childtype.id ][ 'dr_edit' ] is defined %}
    {% set can_edit_child_record = true %}
{% endif %}

{% if insert_fake_datarecord is not defined %}
    {% set insert_fake_datarecord = false %}
{% endif %}
{#
--------------------<br>
fake_edit_fieldarea_childtype.html.twig<br>
target_datatype_id: {{ target_datatype_id }}<br>
parent_datarecord.datatype: {{ parent_datatype_id }}<br>
multiple_allowed: {{ multiple_allowed }}<br>
child_datarecord_count: {{ child_datarecord_count }}<br>
can_add_child_record: {{ can_add_child_record }}<br>
can_edit_child_record: {{ can_edit_child_record }}<br>
is_link: {% if is_link == 1 %}yes{% else %}no{%endif %}<br>
--------------------<br>
#}
<div class="ODRChildDatatype" id="ChildTypeWrapper_{{ childtype.id }}_{{ parent_datarecord.id }}">
{% if is_link == 0 and not can_edit_child_record %}
    {% include 'ODRAdminBundle:Display:display_childtype.html.twig' with {
        'datatype_array': datatype_array,
        'datarecord_array': datarecord_array,
        'theme_array': theme_array,

        'target_datatype_id': target_datatype_id,
        'parent_datarecord_id': datarecord.id,
        'target_theme_id': target_theme_id,

        'is_top_level': 0,
        'is_link': theme_datatype.is_link,
        'display_type': theme_datatype.display_type
    } %}
{% else %}  {# is_link == 1 or can_edit_child_record #}
    {% include 'ODRAdminBundle:FakeEdit:fake_edit_childtype.html.twig' with {
        'datatype_array': datatype_array,
        'datarecord_array': datarecord_array,
        'theme_array': theme_array,

        'target_datatype_id': target_datatype_id,
        'parent_datarecord': parent_datarecord,
        'target_theme_id': target_theme_id,

        'datatype_permissions': datatype_permissions,
        'datafield_permissions': datafield_permissions,

        'is_top_level': 0,
        'is_link': is_link,
        'display_type': display_type,

        'token_list': token_list,
        'insert_fake_datarecord': insert_fake_datarecord,
    } %}
{% endif %}

    <div class="pure-u-1">
    {% if is_link == 1 %}
        {# The InlineLink interface needs to only work when the parent datarecord is not fake #}
        {% if not insert_fake_datarecord %}
        <div class="pure-u-1 Info" title="Record must be saved before it can be linked to other records">
        {% endif %}

        {% if can_edit_parent_record %}
            {# User guaranteed to have can_view_datatype for the remote datatype, and they can edit the parent datarecord #}
            {# Therefore, they can create/remove links to the remote datatype if doing so wouldn't violate multiple_allowed #}
            {% if multiple_allowed == 1 or child_datarecord_count == 0 %}
            <button
                class="pure-button pure-button-primary"
                type="button"
                onclick="AddLinkedRecord({{ childtype.id }},{{ parent_datarecord.id }});"
                {% if not insert_fake_datarecord %}
                disabled
                {% endif %}
            >Add {{ childtype_name }}</button>
            {% endif %}

            <button
                type="button"
                class="pure-button"
                onclick="OpenLinkSearchPage({{ parent_datatype_id }},{{ childtype.id }},{{ parent_datarecord.id }});"
                {% if not insert_fake_datarecord %}
                disabled
                {% endif %}
            >Link to {{ childtype_name }}</button>
        {% endif %}

        {% if not insert_fake_datarecord %}
        </div>
        {% endif %}

    {% else %}
        {# Getting ODR to render fake child records when the top-level is also fake is painful #}
        {# Disable this feature, for now #}
        <div class="pure-u-1 Info" title="Record must be saved before child records can be created">

        {% if can_add_child_record and (multiple_allowed == 1 or child_datarecord_count < 1) %}
            <button
                class="pure-button pure-button-primary"
                type="button"
                onclick="AddChildRecord({{ childtype.id }},{{ parent_datarecord.id }});"
                disabled
            >Add {{ childtype_name }} record</button>
        {% endif %}

        </div>

    {% endif %}
    </div>

</div><!-- End of #ChildTypeWrapper_{{ target_datatype_id }}_{{ parent_datarecord.id }} -->

{% endspaceless %}
