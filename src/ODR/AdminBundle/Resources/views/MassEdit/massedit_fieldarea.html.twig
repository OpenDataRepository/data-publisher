{% spaceless %}

{% set datatype = datatype_tree.datatype %}

{% for data in datatype_tree.theme_elements %}

    {% set element = data.theme_element %}
    {# inverse of "if datatype_tree.is_link == 1 and element.displayinresults == 0" #}
    {% if datatype_tree.is_link == 0 or element.displayinresults == 1 %}
        <div id="ThemeElement_{{ element.id }}" class="ODRThemeElement pure-u-1 pure-u-md-{{ element.getcsswidthmed }} pure-u-xl-{{ element.getcsswidthxl }}">
            <div class="ODRInnerBox">
{#
            {% if datatype_tree.is_link == 0 %}

            <div id="ThemeElementTools_{{ element.id }}" class="DataTypeTools pure-u-1"><span style="float:right;">
                <i class="Pointer tooltip fa fa-info-circle ODRThemeElementProperties" title="ThemeElement Properties" rel="{{ element.id }}"></i>
                <i class="Pointer tooltip fa {% if element.displayinresults == 1 %}fa-eye{% else %}fa-eye-slash{% endif %} ODRThemeElementVisible" title="ThemeElement{% if element.displayinresults == 0 %} not{% endif %} visible to public" rel="{{ element.id }}"></i>

                <i class="Pointer tooltip fa fa-plus-square {% if data.datatype != null %}fa-muted{% endif %} ODRAddDatafield" title="Add DataField" rel="{{ datatype.id }}"></i>
                <i class="Pointer tooltip fa fa-list-alt {% if data.datatype != null or data.datafields != null %}fa-muted{% endif %} ODRAddChildtype" title="Add Child Type" rel="{{ datatype.id }}"></i>

                {% if data.datafields != null or (data.datatype != null and data.datatype.is_link == 0) %}
                    <i class="Pointer tooltip fa fa-link fa-muted ODRLinkDatatype" title="Link DataType" rel="{{ datatype.id }}"></i>
                {% elseif data.datatype != null and data.datatype.is_link == 1 %}
                    <i class="Pointer tooltip fa fa-link ODRActiveIcon ODRLinkDatatype" title="Link DataType" rel="{{ datatype.id }}"></i>
                {% else %}
                    <i class="Pointer tooltip fa fa-link ODRLinkDatatype" title="Link DataType" rel="{{ datatype.id }}"></i>
                {% endif %}

                <i class="Pointer tooltip fa fa-trash-o {% if data.datafields != null or data.datatype != null %}fa-muted{% endif %} ODRDeleteThemeElement" title="Delete ThemeElement" rel="{{ element.id }}"></i>
            </span></div>

            {% endif %}
#}
    {% endif %}


    {% if datatype_tree.is_link == 1 and element.displayinresults == 0 %}
        {# don't render hidden theme_elements off linked types? #}
    {% elseif data.datafields != null %}
        {# render all datafields in this theme element #}
        {% for datafield in data.datafields %}

            {% set theme_datafield = datafield.theme_datafield %}
            {% set datafield = datafield.datafield %}

            {% set can_view_datafield = 0 %}
            {% set can_edit_datafield = 0 %}
            {% if datafield_permissions[ datafield.id ] is defined and datafield_permissions[ datafield.id ][ 'view' ] is defined %}
                {% set can_view_datafield = 1 %}
            {% endif %}
            {% if datafield_permissions[ datafield.id ] is defined and datafield_permissions[ datafield.id ][ 'edit' ] is defined %}
                {% set can_edit_datafield = 1 %}
            {% endif %}


            {% set field_typename = datafield.fieldtype.typename %}

            {% if field_typename != "File" and field_typename != "Image" %}
                <div class="ODRDataField pure-u-1 pure-u-md-{{ theme_datafield.getcsswidthmed }} pure-u-xl-{{ theme_datafield.getcsswidthxl }}" id="Field_{{ datafield.id }}" >
    
                {% if field_typename == "Markdown" %}
                    {% include 'ODRAdminBundle:Results:results_markdown.html.twig' with {'field': datafield} %}
                {% elseif can_view_datafield == 1 %}
                    {% include 'ODRAdminBundle:MassEdit:massedit_datafield.html.twig' with {'fieldtheme': theme_datafield, 'field': datafield, 'can_edit_datafield': can_edit_datafield} %}
                {% else %}
                    {# user can't view or edit datafield, don't display anything #}
                {% endif %}

                </div><!-- end of #Field_{{ datafield.id }} -->
            {% endif %}

        {% endfor %}
    {% elseif data.datatype != null %}
        {# render the child/linked datatype in this theme element #}
{#
        {% import "ODRAdminBundle:Displaytemplate:design_area_childtype.html.twig" as mychildform %}
        {{ mychildform.input(data.datatype, datafield_permissions) }}
#}
    {% endif %}


    {# inverse of "if datatype_tree.is_link == 1 and element.displayinresults == 0" #}
    {% if datatype_tree.is_link == 0 or element.displayinresults == 1 %}
            </div><!-- End of .ODRInnerBox -->
        </div><!-- End of #ThemeElement_{{ element.id }} -->
    {% endif %}

{% endfor %}

{% endspaceless %}
