{% spaceless %}

{% set datatype = datatype_array[initial_datatype_id] %}

{% if record_display_view == "single" %}
<h1 class="no-margin-top-phone">
    <span>Search Result &raquo; {{ datatype.dataTypeMeta.shortName }}</span>
    <a id="page_settings" name="page_settings"><i class="fa fa-md fa-fw fa-cog"></i></a>
</h1>
{# Record View Menu #}
{# include 'ODRAdminBundle:Display:display_area.html.twig' #}
    <div id="page_settings_menu" class="pure-menu pure-menu-horizontal" style="display:none;">
        <ul class="pure-menu-list">
            <li class="pure-menu-item">
                <a name="ChooseView" id="ChooseView" class="pure-menu-link">Choose View</a>
            </li>
            <li class="pure-menu-item">
                <a name="CustomizeView" id="CustomizeView" class="pure-menu-link">Customize View</a>
            </li>
            <!-- <li class="pure-menu-item">
                <div class="pure-menu-link">
                    <label for="state">State</label>
                    <select id="state" class="pure-input-1-2">
                        <option>AL</option>
                        <option>CA</option>
                        <option>IL</option>
                    </select>
                </div>
            </li> -->
        </ul>
    </div>

{# End Record View Menu #}
{% endif %}

{% include 'ODRAdminBundle:Display:display_area.html.twig' with {
    'datatype_array': datatype_array,
    'datarecord_array': datarecord_array,
    'theme_id': theme_id,

    'initial_datatype_id': initial_datatype_id,
    'initial_datarecord_id': initial_datarecord_id,

    'is_top_level': is_top_level,
} %}

{% if record_display_view == "single" %}
<div id="download_files_dialog_wrapper">
    {% include 'ODRAdminBundle:Default:file_download_dialog.html.twig' %}
</div>
{% endif %}

{% if record_display_view == "single" %}
<script>

    var record_datatype_id = {{ datatype.id }};
    var record_theme_id = {{ theme_id }};
    function initPage() {

        // Resize all elements dependent on window size
        $(window).unbind('resize').resize(function() {
            WindowResizeInterval = window.clearInterval(WindowResizeInterval);      // WindowResizeInterval variable defined in common.js
            WindowResizeInterval = window.setInterval("onWindowResize()", 500);
        });

        // Resize everything prior to divs being hidden
        onWindowResize();

        // Set up image galleries
        setupImageGalleries();

        // Hide divs for accordion purposes
        setupAccordions();

        $("#page_settings").unbind('click').click(function(event) {
            // Load content after reveal...
            $("#page_settings_menu").toggle('fast');
        })

        $(".ODRFileDownloadProgress").hide();

        $("a.ODRFileDownload").unbind('click').click(function(event) {
            // Grab necessary attributes
            var file_id = $(this).attr('rel');
            var href = $(this).attr('href');

            // Prevent the click handler for <tr> elements from firing if a file download href is clicked
            var short_form = false;
            var can_cancel = false;
            handleFileDownload(event, file_id, href, short_form, can_cancel);    // defined in Default::file_handling.html.twig
        });

        $(".ODRDownloadAllFiles").unbind('click').click(function() {

            if ( $(this).hasClass('fa-muted') )
                return;

            // Grab necessary attributes
            var element = $(this);

            var id_data = $(this).closest(".ODRDataField").first().attr('id').split(/_/);
            var datarecord_id = id_data[1];
            var datafield_id = id_data[2];

            $("#dialog_file_downloads").dialog( "open" );
            locateFileIds({{ initial_datarecord_id }}, datarecord_id, datafield_id);      // defined in ODRAdminBundle:Default:file_download_dialog.html.twig
        });

    }

    function ReloadDatafield(datarecord_id, datafield_id) {

        var datafield_div = $("#Field_" + datarecord_id + "_" + datafield_id);
        var theme_id = $(datafield_div).attr('rel');

        var url = '{{ path('odr_display_reload_datafield', { 'datarecord_id': 0, 'datafield_id': 0, 'theme_id': 0 }) }}';
        url = url.substring(0, (url.length - 5));
        url += datarecord_id + '/' + datafield_id + '/' + theme_id;

        $(datafield_div).children('form').each(function () {
            $(this).fadeOut();
            $(this).remove();
        });

        $.ajax({
            cache: false,
            type: 'GET',
            url: url,
            dataType: "json",
            success: function (data, textStatus, jqXHR) {
                if (data.r == 0) {
                    $(datafield_div).append(data.d.html);
                    initPage();
                }
                else {
                    alert(data.d);
                }
            },
            complete: function (jqXHR, textStatus) {
                // Get the xdebugToken from response headers
                var xdebugToken = jqXHR.getResponseHeader('X-Debug-Token');

                // If the Sfjs object exists
                if (typeof Sfjs !== "undefined") {
                    // Grab the toolbar element
                    var currentElement = $('.sf-toolbar')[0];

                    // Load the data of the given xdebug token into the current toolbar wrapper
                    Sfjs.load(currentElement.id, '/app_dev.php/_wdt/' + xdebugToken);
                }
            }
        });
    }

    $(function() {
        initPage();
        $(".MenuDesignArea").remove();
        window.scrollTo(0,0);
    });
{% endif %}

</script>
{% endspaceless %}
