{% spaceless %}

<!-- Tag Edit Dialog Form -->

<script>

    var tag_edit_body = '<div id="ODRTagEditDialogWrapper" class="ODRHidden"> </div>';

    function openTagEditDialog(datafield_id) {
        // open dialog
        modal_options = {
            title: 'Tag Design',
            loading: true,
            body: tag_edit_body,
            buttons: [
                {
                    id: 'ODRTagEdit_close',
                    text: 'Close'
                }
            ]
        };
        openODRRemodal(modal_options);

        loadTagEditDialog(datafield_id);

        // Attach an event handler to the close button
        $("#ODRTagEdit_close").unbind('click').click(function() {
            {# defined in ODRAdminBundle:Tags:tag_design_wrapper.html.twig #}
            // Force a save of the currently highlighted tag's position, if applicable
            clearTagHighlights();

            closeODRRemodal();
            ReloadSearchOverlayDatafield(datafield_id);
        });
    }

    function loadTagEditDialog(datafield_id) {

        var url  = '{{ path('odr_get_tag_modal', {'datafield_id': 0} ) }}';
        url = url.substring(0,(url.length-1));
        url += datafield_id;

        $.ajax({
            cache: false,
            type: 'GET',
            url: url,
            dataType: "json",
            success: function(data) {
                $("#ODRTagEditDialogWrapper").html( data.d.html );

                // remove loading spinner
                $(".ODRRemodalLoading").fadeOut('150', function() {
                    $(".ODRRemodalBody").show();
                    $(".ODRRemodalButtons").show();
                    $("#ODRTagEditDialogWrapper").show();

                    // Resize ODRFileDownloadModal to take up full height
                    var expected_height = resetRemodalInnerHeight();

                    // Get the maximum size of the remodal content area, minus some padding
                    var max_height = expected_height - 50;

                    // Subtract the height of the create/import tags buttons div
                    max_height = max_height - $("#odr_tag_design_modal").children('.ODRThemeElement').first().height();
                    // Subtract the height of the close button div
                    max_height = max_height - $(".ODRRemodalButtons").first().height();

                    // Set the max height of the tag form so it doesn't have a vertical scroll bar
                    $("#ODRTagForm").css('max-height', max_height);
                });
            },
            error: function(jqXHR, textStatus, errorThrown) {
                // Close the dialog so it's not in some half-initialized state
                closeODRRemodal();
            },
            complete: function(jqXHR) {
                // Get the xdebugToken from response headers
                var xdebugToken = jqXHR.getResponseHeader('X-Debug-Token');

                // If the Sfjs object exists
                if (typeof Sfjs !== "undefined") {
                    // Grab the toolbar element
                    var currentElement = $('.sf-toolbar')[0];

                    // Load the data of the given xdebug token into the current toolbar wrapper
                    Sfjs.load(currentElement.id, '/app_dev.php/_wdt/'+ xdebugToken);
                }
            }
        });
    }

    function ReloadSearchOverlayDatafield(datafield_id) {
        // This should always exist by now, but just in case...
        if ( $(".ODRSearchToggle").length > 0 ) {
            var url  = '{{ path('odr_reload_search_overlay_datafield', {'datafield_id': 0} ) }}';
            url = url.substring(0,(url.length-1));
            url += datafield_id;

            $.ajax({
                cache: false,
                type: 'GET',
                url: url,
                dataType: "json",
                success: function(data) {
                    // Only update this datafield's HTML element on the search sidebar if it exists
                    if ( data.d.needs_update === true )
                        $("#Input_" + datafield_id + ".ODRTagSearchDiv").parent().html( data.d.html );
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    // Close the dialog so it's not in some half-initialized state
                    closeODRRemodal();
                },
                complete: function(jqXHR) {
                    // Get the xdebugToken from response headers
                    var xdebugToken = jqXHR.getResponseHeader('X-Debug-Token');

                    // If the Sfjs object exists
                    if (typeof Sfjs !== "undefined") {
                        // Grab the toolbar element
                        var currentElement = $('.sf-toolbar')[0];

                        // Load the data of the given xdebug token into the current toolbar wrapper
                        Sfjs.load(currentElement.id, '/app_dev.php/_wdt/'+ xdebugToken);
                    }
                }
            });
        }
    }
</script>

<!-- End of Tag Edit Dialog Form -->

{% endspaceless %}
