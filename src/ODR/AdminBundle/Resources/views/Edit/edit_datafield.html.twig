{% spaceless %}

{% set field_typename = datafield.dataFieldMeta.fieldType.typeName %}
{% set field_typeclass = datafield.dataFieldMeta.fieldType.typeClass %}

{% set valuefield = '' %}
{% set valuefield_value = '' %}
{% if datarecord.dataRecordFields[ datafield.id ] is defined %}
    {% set datarecordfield = datarecord.dataRecordFields[ datafield.id ] %}

    {% if field_typename == "Boolean" %}
        {% set valuefield = datarecordfield.boolean[0] %}
        {% set valuefield_value = valuefield.value %}
    {% elseif field_typename == "File" %}
        {% set valuefield = datarecordfield.file %}
    {% elseif field_typename == "Image" %}
        {% set valuefield = datarecordfield.image %}
    {% elseif field_typename == "Decimal" %}
        {% set valuefield = datarecordfield.decimalValue[0] %}
        {% set valuefield_value = valuefield.value %}
    {% elseif field_typename == "Integer" %}
        {% set valuefield = datarecordfield.integerValue[0] %}
        {% set valuefield_value = valuefield.value %}
    {% elseif field_typename == "Paragraph Text" %}
        {% set valuefield = datarecordfield.longText[0] %}
        {% set valuefield_value = valuefield.value %}
    {% elseif field_typename == "Long Text" %}
        {% set valuefield = datarecordfield.longVarchar[0] %}
        {% set valuefield_value = valuefield.value %}
    {% elseif field_typename == "Medium Text" %}
        {% set valuefield = datarecordfield.mediumVarchar[0] %}
        {% set valuefield_value = valuefield.value %}
    {% elseif field_typeclass == "Radio" %}
        {% set valuefield = datarecordfield.radioSelection %}
    {% elseif field_typename == "Short Text" %}
        {% set valuefield = datarecordfield.shortVarchar[0] %}
        {% set valuefield_value = valuefield.value %}
    {% elseif field_typename == "DateTime" %}
        {% set valuefield = datarecordfield.datetimeValue[0] %}
        {% set valuefield_value = valuefield.value %}
    {% elseif field_typename == "Markdown" %}
        {% set valuefield = '' %}
    {% endif %}

{% endif %}

{% if valuefield == '' and (field_typename == 'File' or field_typename == 'Image' or field_typeclass == 'Radio') %}
    {% set valuefield = [] %}
{% endif %}

{% set max_length = '' %}
{% if field_typename == "Long Text" %}
    {% set max_length = 255 %}
{% elseif field_typename == "Medium Text" %}
    {% set max_length = 64 %}
{% elseif field_typename == "Short Text" %}
    {% set max_length = 32 %}
{% endif %}

{% set unique_id = datarecord.id ~ '_' ~ datafield.id %}
{% set input_id = field_typeclass ~ 'Form_' ~ unique_id %}
{% set input_name = field_typeclass ~ 'Form[value]' %}


    <form action="{{ path('odr_record_save', { 'datarecord_id': datarecord.id, 'datafield_id': datafield.id }) }}" class="pure-u-1" id="EditForm_{{ unique_id }}" method="POST">

        <input type="hidden" id="{{ field_typeclass }}Form__token" name="{{ field_typeclass }}Form[_token]" value="{{ token_list[ datarecord.id ][ datafield.id ] }}" />
{#
        <input type="hidden" name="{{ field_typeclass }}Form_datarecord" value="{{ datarecord.id }}" />
        <input type="hidden" name="{{ field_typeclass }}Form_datafield" value="{{ datafield.id }}" />
#}

    {% if field_typename == "Boolean" %}
        <fieldset>
            <label for="{{ input_id }}" class="ODRFieldLabel pure-u-1" style="margin:0.5em 0;" title="{{ datafield.dataFieldMeta.description }}">
                <div class="ODRFieldWrapper" id="Input_{{ unique_id }}">
                    <input id="{{ input_id }}" type="checkbox" name="{{ input_name }}" value="1" {% if valuefield_value == 1 %}checked{% endif %} />
                    <span class="ODRDatafieldHistory">{{ datafield.dataFieldMeta.fieldName }}</span>
                </div>
            </label>
        </fieldset>

    {% elseif field_typename == "File" %}
        {% set has_file = false %}
        {% if valuefield|length > 0 %}
            {% set has_file = true %}
        {% endif %}

        {#<fieldset>#}
        <div class="ODRFileDatafield">
            {% include "ODRAdminBundle:Edit:edit_file_datafield.html.twig" with {'files': valuefield, 'datafield': datafield, 'datarecord': datarecord} %}
        </div>

        <div class="pure-u-1" {% if datafield.dataFieldMeta.allow_multiple_uploads == 0 and has_file == true %}style="display: none;"{% endif %}>
            {# show upload area only if multiples are allowed or nothing has been uploaded yet #}
            {% set target = 'drf_' ~ datarecord.id ~ '_' ~ datafield.id %}
            {% set single_file = true %}
            {% if datafield.dataFieldMeta.allow_multiple_uploads == 1 %}
                {% set single_file = false %}
            {% endif %}
            {% set callback = 'ReloadFileDatafield(' ~ datarecord.id ~ ',' ~ datafield.id ~ ');' %}

            {% include 'ODRAdminBundle:Flow:flow_upload.html.twig' with {'target': target, 'single_file': single_file, 'upload_type': 'file', 'datatype_id': datatype.id, 'datarecord_id': datarecord.id, 'datafield_id': datafield.id, 'callback': callback} %}
        </div>
        {#</fieldset>#}

    {% elseif field_typename == "Image" %}
        {% set has_image = false %}
        {#<fieldset>#}
            <label id="Label_{{ datafield.id }}" class="ODRFieldLabel pure-u-1" title="{{ datafield.dataFieldMeta.description }}" style="text-align: center;">{{ datafield.dataFieldMeta.fieldName }}</label>
            <div class="ODRSortableImage pure-u-1">

                {% for image in valuefield %}
                    {% set oimage = image.parent %}
                    {% set image_ext = oimage.ext %}
                    {% set image_caption = oimage.imageMeta.caption %}
                    {% set image_filename = oimage.imageMeta.originalFileName %}

                    {% set has_image = true %}

                    <div id="Image_{{ oimage.id }}" class="pure-u-1 pure-u-md-1-{{ datafield.dataFieldMeta.children_per_row }}" rel="{{ image.id }}">    {# rel is the id of the thumbnail, id attr is the id of the full-size image #}
                        <div class="pure-u-1">
                            &nbsp;<i class="Cursor tooltip fa fa-calendar fa-lg" title="Uploaded {{ oimage.created|date('Y-m-d') }} by {{ oimage.createdBy|user_string }}"></i>
                            &nbsp;<i class="ODRDeleteImage tooltip Pointer fa fa-lg fa-trash-o" title="Delete Image" rel="{{ oimage.id }}"></i>
                            &nbsp;<i class="ODRPublicImage tooltip Pointer fa fa-lg fa-globe {% if not oimage.imageMeta.publicDate|is_public %}IconRed{% endif %}" title="{% if not oimage.imageMeta.publicDate|is_public %}Image is not public{% else %}Public since {{ oimage.imageMeta.publicDate|date('Y-m-d') }}{% endif %}" rel="{{ oimage.id }}"></i>
                            &nbsp;<i class="ODRRotateImage tooltip Pointer fa fa-lg fa-rotate-left" title="Rotate Image 90 degrees counter-clockwise" rel="{{ oimage.id }}"></i>
                            &nbsp;<i class="ODRRotateImage tooltip Pointer fa fa-lg fa-rotate-right" title="Rotate Image 90 degrees clockwise" rel="{{ oimage.id }}"></i>
                            &nbsp;
                        </div>
                        <div class="pure-u-23-24">
                            <a target="_blank" href="{{ path('odr_image_download', {'image_id': oimage.id}) }}" title="{{ image_caption }}">
                                <img class="pure-img" src="{{ path('odr_image_download', {'image_id': image.id}) }}{% if force_image_reload %}?{{ date().timestamp }}{% endif %}" title="{% if image_filename != null %}{{ image_filename }}{% else %}Image_{{ image.id }}.{{ image_ext }}{% endif %}" />
                            </a>
                        </div>
                    </div>
                {% endfor %}

            </div>
            <div class="pure-u-1">
            {% if datafield.dataFieldMeta.allow_multiple_uploads == 1 or has_image == false %}
                {# show upload area only if multiples are allowed or nothing has been uploaded yet #}
                {% set target = 'drf_' ~ datarecord.id ~ '_' ~ datafield.id %}
                {% set single_file = true %}
                {% if datafield.dataFieldMeta.allow_multiple_uploads == 1 %}
                    {% set single_file = false %}
                {% endif %}
                {% set callback = 'ReloadDatafield(' ~ datarecord.id ~ ',' ~ datafield.id ~ ');' %}

                {% include 'ODRAdminBundle:Flow:flow_upload.html.twig' with {'target': target, 'single_file': single_file, 'upload_type': 'image', 'datatype_id': datatype.id, 'datarecord_id': datarecord.id, 'datafield_id': datafield.id, 'callback': callback} %}
            {% endif %}
            </div>
        {#</fieldset>#}

    {% elseif field_typename == "Paragraph Text" %}
        <fieldset>
            <label for="{{ input_id }}" class="ODRFieldLabel ODRDatafieldHistory" title="{{ datafield.dataFieldMeta.description }}">{{ datafield.dataFieldMeta.fieldName }}</label>
            <div class="ODRFieldWrapper" id="Input_{{ unique_id }}">
                <textarea id="{{ input_id }}" class="pure-u-1" name="{{ input_name }}" {% if datafield.dataFieldMeta.required == 1 %}required="required"{% endif %} data-error-type="inline">{{ valuefield_value }}</textarea>
            </div>
        </fieldset>

    {% elseif field_typename == "Integer" or field_typename == "Decimal" or field_typename == "Long Text" or field_typename == "Medium Text" or field_typename == "Short Text" %}
        <fieldset>
            <label for="{{ input_id }}" class="ODRFieldLabel ODRDatafieldHistory" title="{{ datafield.dataFieldMeta.description }}">{{ datafield.dataFieldMeta.fieldName }}</label>
            <div class="ODRFieldWrapper" id="Input_{{ unique_id }}">
                <input type="text" id="{{ input_id }}" class="pure-u-1" name="{{ input_name }}" value="{{ valuefield_value }}" data-error-type="inline" />
            </div>
        </fieldset>

    {#{% elseif field_typename == "Single Radio" or field_typename == "Multiple Radio" %}#}
    {% elseif field_typename == "Single Radio" or field_typename == "Multiple Radio" or field_typename == "Multiple Select" %}
        <fieldset>
            <label class="ODRFieldLabel {#ODRDatafieldHistory#} pure-u-1" title="{{ datafield.dataFieldMeta.description }}">{{ datafield.dataFieldMeta.fieldName }}</label>

            {% set print_null_option = false %}
            {% set has_selection = false %}
            {% if field_typename == "Single Radio" %}
                {% set print_null_option = true %}
    
                {% for radio_selection in valuefield %}
                    {% if radio_selection.selected == 1 %}
                        {% set has_selection = true %}
                    {% endif %}
                {% endfor %}
            {% endif %}

            {% if datafield.radioOptions is defined %}
                {% for radio_option in datafield.radioOptions %}
                    {% set is_selected = 0 %}
                    {% if datarecordfield.radioSelection[ radio_option.id ] is defined %}
                        {% set is_selected = datarecordfield.radioSelection[ radio_option.id ].selected %}
                    {% endif %}

                    {% if print_null_option == true %}
                        {% set print_null_option = false %}
                        <label for="{{ input_id }}_0" class="pure-u-1 pure-u-md-1-{{ datafield.dataFieldMeta.children_per_row }}" style="margin: 0.5em 0;">
                            <input id="{{ input_id }}_0" type="radio" name="RadioGroup_{{ unique_id }}" {% if has_selection == false %}checked{% endif %} class="SingleRadioGroup {% if has_selection == false %}ODRRadioOptionChecked{% endif %}" />
                            No Option Selected
                        </label>
                    {% endif %}

                    <label for="{{ input_id }}_{{ radio_option.id }}" class="pure-u-1 pure-u-md-1-{{ datafield.dataFieldMeta.children_per_row }}" style="margin: 0.5em 0;">

                    {% if field_typename == "Single Radio" %}
                        <input id="{{ input_id }}_{{ radio_option.id }}" type="radio" name="RadioGroup_{{ unique_id }}" {% if is_selected == 1 %}checked{% endif %} class="SingleRadioGroup {% if is_selected == 1 %}ODRRadioOptionChecked{%endif %}" />
                    {% else %}
                        <input id="{{ input_id }}_{{ radio_option.id }}" type="checkbox" name="RadioGroup_{{ unique_id }}" {% if is_selected == 1 %}checked{% endif %} class="MultipleRadioGroup" />
                    {% endif %}

                    {{ radio_option.radioOptionMeta.optionName }}
                    </label>
                {% endfor %}
            {% endif %}

        <fieldset>

    {#{% elseif field_typename == "Single Select" or field_typename == "Multiple Select" %}#}
    {% elseif field_typename == "Single Select" %}
        <fieldset>
            <label for="{{ input_id }}" class="ODRFieldLabel {#ODRDatafieldHistory#} pure-u-1" title="{{ datafield.dataFieldMeta.description }}">{{ datafield.dataFieldMeta.fieldName }}</label>

            <select id="{{ input_id }}" class="pure-u-23-24 {% if field_typename == "Multiple Select" %}MultipleSelectGroup{% else %}SingleSelectGroup{% endif %}" {% if field_typename == "Multiple Select" %}multiple{% endif %}>

            {% if datafield.radioOptions is defined %}
                {% if field_typename == "Single Select" %}
                    <option id="Option_0" value="0">No Option Selected</option>
                {% endif %}

                {% for radio_option in datafield.radioOptions %}
                    {% set is_selected = 0 %}
                    {% if datarecordfield.radioSelection[ radio_option.id ] is defined %}
                        {% set is_selected = datarecordfield.radioSelection[ radio_option.id ].selected %}
                    {% endif %}

                    <option id="Option_{{ radio_option.id }}" value="{{ radio_option.id}}" {% if is_selected == 1 %}selected {% if field_typename == "Multiple Select" %}class="MultipleSelect_prev"{% endif %}{% endif %}>{{ radio_option.radioOptionMeta.optionName }}</option>
                {% endfor %}
            {% endif %}
            </select>

        </fieldset>

    {% elseif field_typename == "DateTime" %}
        {% set new_id = 'DatetimeValueForm_value_' ~ datafield.id %}
        <fieldset>
            <label for="{{ new_id }}" class="ODRFieldLabel ODRDatafieldHistory" title="{{ datafield.dataFieldMeta.description }}">{{ datafield.dataFieldMeta.fieldName }}</label>
            <div class="ODRFieldWrapper" id="Input_{{ unique_id }}">
                <input type="text" id="{{ new_id }}" class="Pointer pure-u-1 ODRDatePicker" name="{{ input_name }}" readonly="readonly" value="{% if valuefield_value != '' and valuefield_value|date('Y-m-d') != "9999-12-31" %}{{ valuefield_value|date('Y-m-d') }}{% endif %}" data-error-type="inline" />
            </div>
            <div style="margin-bottom:5px;"><label class="Pointer ODRDatePicker_clear"><u>Clear Date</u></label></div>
        </fieldset>

    {% endif %}
    </form>

{% if field_typename == "Boolean" %}
    <script type="text/javascript">
        window.{{ field_typeclass }}Interval_{{ unique_id }} = null;
        $("#EditForm_{{ unique_id }}").find("input[name='{{ input_name }}'").unbind('change').change(function() {
            window.{{ field_typeclass }}Interval_{{ unique_id }} = window.clearInterval( window.{{ field_typeclass }}Interval_{{ unique_id }} );
            window.{{ field_typeclass }}Interval_{{ unique_id }} = window.setInterval( "$('#EditForm_{{ unique_id }}').submit()", SaveTimeout );
        });

        $("#EditForm_{{ unique_id }}").validate({
            submitHandler: function(form) {
                SaveRecordData(
                    '#EditForm_{{ unique_id }}',
                    window.{{ field_typeclass }}Interval_{{ unique_id }}
                )
            }
        });
    </script>
{% elseif field_typename == "File" or field_typename == "Image" %}
    {# handled elsewhere by flow.js #}
{% elseif field_typename == "Integer" or field_typename == "Decimal" or field_typename == "Paragraph Text" or field_typename == "Long Text" or field_typename == "Medium Text" or field_typename == "Short Text" %}
    <script type="text/javascript">
        window.{{ field_typeclass }}Interval_{{ unique_id }} = null;
        $("#EditForm_{{ unique_id }}").find("{% if field_typename == 'Paragraph Text' %}textarea{% else %}input{% endif %}[name='{{ input_name }}'").unbind('change').unbind('keyup').unbind('paste').on('keyup paste', function() {
            window.{{ field_typeclass }}Interval_{{ unique_id }} = window.clearInterval( window.{{ field_typeclass }}Interval_{{ unique_id }} );
            window.{{ field_typeclass }}Interval_{{ unique_id }} = window.setInterval( "$('#EditForm_{{ unique_id }}').submit()", SaveTimeout );
        });

        $("#EditForm_{{ unique_id }}").validate({
    {% if field_typename == "Integer" %}
            rules: {
                "{{ input_name }}": {
                    ODRInteger: {}  {# 'ODRInteger' rule defined in app.js...the default 'digits' rule apparently doesn't allow negative numbers #}
                }
            },
    {% elseif field_typename == "Decimal" %}
            rules: {
                "{{ input_name }}": {
                    number: true
                }
            },
    {% elseif field_typename == "Long Text" or field_typename == "Medium Text" or field_typename == "Short Text" %}
            rules: {
                "{{ input_name }}": {
                    maxlength: {{ max_length }}
                }
            },
            messages: {
                "{{ input_name }}": {
                    maxlength: "{{ max_length }} characters max"
                }
            },
    {% endif %}
            submitHandler: function(form) {
                SaveRecordData(
                    '#EditForm_{{ unique_id }}',
                    window.{{ field_typeclass }}Interval_{{ unique_id }}
                )
            }
        });
    </script>
{% endif %}


{% endspaceless %}
