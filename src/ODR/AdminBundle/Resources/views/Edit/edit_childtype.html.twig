{% spaceless %}

{% set datatype = datatype_array[target_datatype_id] %}

{% set can_edit_record = 0 %}
{% set can_add_record = 0 %}
{% set can_delete_record = 0 %}
{% if datatype_permissions[ datatype.id ] is defined and datatype_permissions[ datatype.id ][ 'dr_edit' ] is defined %}
    {% set can_edit_record = 1 %}
{% endif %}
{% if datatype_permissions[ datatype.id ] is defined and datatype_permissions[ datatype.id ][ 'dr_add' ] is defined %}
    {% set can_add_record = 1 %}
{% endif %}
{% if datatype_permissions[ datatype.id ] is defined and datatype_permissions[ datatype.id ][ 'dr_delete' ] is defined %}
    {% set can_delete_record = 1 %}
{% endif %}


{# Determine the list of datarecords to display at this point in time #}
{% set datarecord_list = {} %}
{% if is_top_level == 1 %}
    {% set datarecord_list = datarecord_list|merge({ (parent_datarecord_id): datarecord_array[parent_datarecord_id] }) %}   {# parent_datarecord_id will NOT be the key due to twig's use of php array_merge #}
{% else %}
    {% set parent_datarecord = datarecord_array[parent_datarecord_id] %}

    {% if parent_datarecord['children'][target_datatype_id] is defined %}
        {% for num, dr_id in parent_datarecord['children'][target_datatype_id] %}
            {% if datarecord_array[dr_id] is defined %}
                {% set datarecord_list = datarecord_list|merge({ (dr_id): datarecord_array[dr_id] }) %}     {# dr_id will NOT be the key due to twig's use of php array_merge #}
            {% endif %}
        {% endfor %}
    {% endif %}
{% endif %}


<div class="ODRDataType pure-u-1" id="DataType_{{ datatype.id }}">

    {% include 'ODRAdminBundle:Default:fieldarea_header.html.twig' with {
        'datatype': datatype,
        'datarecord_list': datarecord_list,

        'is_top_level': is_top_level,
        'is_link': is_link,
        'display_type': display_type
    } %}

    {% for num, datarecord in datarecord_list %}
{#
----------</br>
datarecord: {{ datarecord.id }}...datatype {{ datarecord.dataType.id }}</br>
parent: {{ datarecord.parent.id }}</br>
grandparent: {{ datarecord.grandparent.id }}</br>
</br>
parent_datarecord_id: {{ parent_datarecord_id }}</br>
target_datatype_id: {{ target_datatype_id }}</br>
</br>
is_top_level: {{ is_top_level }}</br>
is_link: {{ is_link }}</br>
display_type: {{ display_type }}</br>
----------</br>
#}
        {% include 'ODRAdminBundle:Edit:accordion_header.html.twig' with {
            'datarecord': datarecord,
            'datatype': datatype,

            'can_add_record': can_add_record,
            'can_edit_record': can_edit_record,
            'can_delete_record': can_delete_record,

            'is_top_level': is_top_level,
            'display_type': display_type
        } %}

        <div class="ODRFieldArea accordion-content pure-u-1" id="FieldArea_{{ datarecord.id }}">
            {% include 'ODRAdminBundle:Edit:edit_fieldarea.html.twig' with {
                'datatype_array': datatype_array,
                'datarecord_array': datarecord_array,

                'target_datatype_id': target_datatype_id,
                'parent_datarecord_id': parent_datarecord_id,
                'target_datarecord_id': datarecord.id,
                'theme_id': theme_id,

                'datatype_permissions': datatype_permissions,
                'datafield_permissions': datafield_permissions,

                'is_top_level': is_top_level,
                'is_link': is_link,
                'display_type': display_type,

                'token_list': token_list,
            } %}
        </div><!-- End of #FieldArea_{{ datarecord.id }} -->

    {% endfor %}

    {% include 'ODRAdminBundle:Default:fieldarea_footer.html.twig' with {'display_type': display_type } %}

</div><!-- End of #DataType_{{ datatype.id }} -->

{% endspaceless %}
