{% spaceless %}

{% set start = offset - 1 %}
{% if start < 1 %}
    {% set start = 1 %}
{% endif %}

{% set end = offset + 1 %}
{% if end > num_pages %}
    {% set end = num_pages %}
{% endif %}

<div id="pagination_header">
    <div class="pure-u-1 pure-u-xl-5-8">

        <form id="ODRPageSelectForm" name="ODRPageSelectForm">
            <span id="ODRPageSelect" class="odr_page_button Pointer">
                <i class="fa fa-caret-down fa-lg"></i><span class="ODRPaginationLabel">Page&nbsp;</span>
                <input type="text" id="odr_page_input" value="{{ offset }}" size="3" length="10" autocomplete="off"/>&nbsp;of&nbsp;<b>{{ num_pages }}</b>
            </span>
            <span id="ODRPagePopup">Jump to page:
                <button type="button" id="ODRPageSelectButton" class="pure-button" type="submit">Go</button>
            </span>
            {% if offset >= 4 %}
                <button class="ODRPageChooserButton pure-button" onclick="UpdateURL('#{{ path_str }}/1');">
                    <span>1</span>
                </button>
            {% endif %}

            {% if offset >= 5 %}
                &nbsp;<i class="fa fa-ellipsis-h"></i>
            {% endif %}

            {% for i in start..end %}
                <button class="ODRPageChooserButton pure-button {% if i == offset %}pure-button-primary{% endif %}"
                        onclick="UpdateURL('#{{ path_str }}/{{ i }}');">
                    <span>{{ i }}</span>
                </button>
            {% endfor %}

            {% if offset <= num_pages - 4 %}
                &nbsp;<i class="fa fa-ellipsis-h"></i>
            {% endif %}

            {% if offset <= num_pages - 3 %}
                <button class="ODRPageChooserButton pure-button" onclick="UpdateURL('#{{ path_str }}/{{ num_pages }}');">
                    <span>{{ num_pages }}</span>
                </button>
            {% endif %}

            {% if num_datarecords > 0 %}
                <span class="ODRResultsNumRecords"><b>{{ num_datarecords }}</b>&nbsp;<span class="ODRPaginationLabel">records</span></span>
            {% endif %}

        </form>
    </div>
    <div class="pure-u-1 pure-u-xl-3-8">
        <span>
            <span class="ODRPaginationLabel">Show:</span>
            <button type="button" class="ODRPageLength pure-button {% if page_length == 10 %}pure-button-primary{% endif %}" rel="10">10</button>
            <button type="button" class="ODRPageLength pure-button {% if page_length == 25 %}pure-button-primary{% endif %}" rel="25">25</button>
            <button type="button" class="ODRPageLength pure-button {% if page_length == 50 %}pure-button-primary{% endif %}" rel="50">50</button>
            <button type="button" class="ODRPageLength pure-button {% if page_length == 100 %}pure-button-primary{% endif %}" rel="100">100</button>
            <span class="ODRPaginationLabel hidden"> records/page</span>
        </span>

        <a id="page_settings" name="page_settings"><i class="fa fa-md fa-fw fa-cog"></i></a>
    </div>
        {% set is_datatype_admin = false %}
        {% if user_permissions[ datatype.id ] is defined and user_permissions[ datatype.id ][ 'dt_admin' ] is defined %}
            {% set is_datatype_admin = true %}
        {% endif %}

        {% set user_role = '' %}
        {% if user != 'anon.' %}
            {% for role in user.getroles %}
                {% if role == 'ROLE_ADMIN' %}
                    {% set user_role = 'ROLE_ADMIN' %}
                {% endif %}
            {% endfor %}
        {% endif %}


        {# Page/View Options #}
        {% set page_type = 'search_results' %}
        {% if intent == 'linking' %}
            {% set page_type = 'linking' %}
        {% endif %}

        {% include 'ODRAdminBundle:Default:view_manager.html.twig' with {
            'datatype': datatype,
            'theme': theme,
            'page_type': page_type,
            'search_key': search_key,

            'display_export_options': true,
            'intent': intent,
            'user_role': user_role,
            'has_datarecords': has_datarecords,

            'notitle': true,
            'has_search_restriction': has_search_restriction,
            'editable_only': editable_only,
        } %}

</div>

<script>
    $(function() {

        $("#ODRPageSelectForm input[type='text']").on("click", function () {
            $(this).select();
        });

        $("#ODRPageSelectForm").unbind('submit').submit(function (event) {
            event.preventDefault();
            goToPage();
        });

        $(".ODRPageChooserButton").unbind('click').click(function (event) {
            // Prevent form submission when clicking buttons
            event.preventDefault();
        });

        $("#ODRPageSelect").unbind('click').click(function() {
            if ( $("#ODRPagePopup").is(':hidden') )
                $("#ODRPagePopup").fadeIn('fast');
            else
                $("#ODRPagePopup").fadeOut('fast');

            // Calculate where the popup should go
            var selector_offset = $("#ODRPageSelect").offset();
            var selector_height = $("#ODRPageSelect").height();

            var new_offset = {top: selector_offset.top + selector_height + 24, left: selector_offset.left + 20};
            $("#ODRPagePopup").offset( new_offset );
        });



        $("#ODRPageSelectButton").unbind('click').click(function() {
            goToPage();
        });

        $(".ODRPageLength").unbind('click').click(function() {
            var num = $(this).attr('rel');

            var url = '{{ path( 'odr_session_pagelength', {'length': 10} ) }}';
            url = url.substring(0, (url.length-2));
            url += num;

            // Append the tab's id to the get request if it exists
            var data = '';
            if ( window.sessionStorage.getItem('odr_tab_id') )
                data = {'odr_tab_id': window.sessionStorage.getItem('odr_tab_id')};

            $.ajax({
                cache: false,
                type: 'GET',
                url: url,
                data: data,
                dataType: "json",
                success: function(data, textStatus, jqXHR) {
                    var url = "{{ path_str }}" + "/" + "{{ offset }}?odr_tab_id=" + window.sessionStorage.getItem('odr_tab_id');
                    UpdateURL(url);
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    // Don't need to do anything specific on an error
                },
                complete: function(jqXHR, textStatus) {
                    // Get the xdebugToken from response headers
                    var xdebugToken = jqXHR.getResponseHeader('X-Debug-Token');
    
                    // If the Sfjs object exists
                    if (typeof Sfjs !== "undefined") {
                        // Grab the toolbar element
                        var currentElement = $('.sf-toolbar')[0];
    
                        // Load the data of the given xdebug token into the current toolbar wrapper
                        Sfjs.load(currentElement.id, '/app_dev.php/_wdt/'+ xdebugToken);
                    }
                }
            });

        });


        // Setup IntroJS Walkthrough
        jQuery('#ODRHelpButton')
            .attr('data-step', '1')
            .attr('data-intro', 'Welcome to the ODR Help System.  This system will guide you through the features of this page.<br /><br />  For quicker navigation, use your left and right arrow keys to go through the tutorial.');
        jQuery('#page_settings')
            .attr('data-step', '2')
            .attr('data-intro', 'The settings gear contains customizable settings for this page (search results).');
        jQuery('#ChooseView')
            .attr('data-step', '3')
            .attr('data-intro', 'Clicking "Choose View" brings up a menu of options for selecting alternate search views or creating your own.');
        jQuery('#ODRPageSelect')
            .attr('data-step', '4')
            .attr('data-intro', 'You may jump to a specific results page by using the "Jump to page" option.');
        jQuery('.ODRShortResultsHeader:first')
            .attr('data-step', '5')
            .attr('data-intro', 'Click the left side of a result header to view the record.');
        jQuery('.ODRShortResultsHeader_edit:first')
            .attr('data-step', '6')
            .attr('data-intro', 'Click this right side of a result header to enter the edit page for that record.');
        jQuery('#ODRMassEdit')
            .attr('data-step', '7')
            .attr('data-intro', 'Mass edit allows users with appropriate permissions to edit all records in the result list at once.');
        jQuery('#ODRCSVExport')
            .attr('data-step', '8')
            .attr('data-intro', 'CSV Export lets users create CSV downloads of the data in the result list.');
        jQuery('#ODRRunApp')
            .attr('data-step', '9')
            .attr('data-intro', 'If this button is visible, one or more JupyterHub apps will be available in the select box to the left.   ');


        // Initialize the help button
        jQuery('#ODRHelpButton').unbind('click').click(function() {
            introJs()
                .onbeforechange(introJsStepBeforeChangeHandler)
                .onbeforeexit(introJsExitHandler)
                .start();
        });
    });

    function introJsExitHandler() {
    }

    function goToPage() {
        var page = parseInt( $("#odr_page_input").val() );
        if ( isNaN(page) ) {
            $("#odr_page_input").val('');
            return;
        }

        if (page < 1)
            page = 1;
        if (page > {{ num_pages }})
            page = {{ num_pages }};

        var url = "{{ path_str }}" + '/' + page;
        UpdateURL(url);
    }

    function introJsStepBeforeChangeHandler(elem) {
        if(jQuery(elem).attr("id") === "page_settings") {
            if(!jQuery("#page_settings_menu").is(":visible")) {
                jQuery(elem).click();
            }
        }
        if(jQuery(elem).attr("id") === "ChooseView") {
        }
        if(jQuery(elem).attr("id") === "ODRPageSelect") {
            if(jQuery("#ChooseView").is(":visible")) {
                jQuery("#page_settings").click();
            }
            if(!jQuery("#ODRPagePopup").is(":visible")) {
                jQuery(elem).click();
            }
        }
        if(jQuery(elem).hasClass("ODRShortResultsHeader")) {
            if (jQuery("#ODRPagePopup").is(":visible")) {
                jQuery("#ODRPageSelect").click()
            }
        }
    }
</script>
{% endspaceless %}
