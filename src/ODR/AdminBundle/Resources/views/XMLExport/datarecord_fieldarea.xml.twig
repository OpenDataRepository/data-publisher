{% spaceless %}

{% set datatype = datatype_array[target_datatype_id] %}
{% set theme = datatype.themes[theme_id] %}
{% set datarecord = datarecord_array[target_datarecord_id] %}

{# describe datafields first #}
<fields>
{% for theme_element in theme.themeElements %}
    {% if theme_element.themeDataFields is defined %}

        {% for theme_datafield in theme_element.themeDataFields %}
            {% if theme_datafield.dataField is defined %}
                {% set datafield = theme_datafield.dataField %}

                {% if datafield.dataFieldMeta.fieldType.typeName != "Markdown" %}
                    {% include 'ODRAdminBundle:XMLExport:datarecord_datafield.xml.twig' with {
                        'datarecord': datarecord,
                        'datafield': datafield,

                        'is_link': is_link,

                        'using_metadata': using_metadata,
                        'baseurl': baseurl,
                        'version': version,
                    } %}
                {% endif %}
            {% endif %}
        {% endfor %}
    {% endif %}
{% endfor %}
</fields>

{# describe child datarecords second #}
<child_records>
{% for theme_element in theme.themeElements %}
    {% if theme_element.themeDataType is defined %}

        {% for theme_datatype in theme_element.themeDataType %}     {# only ever going to be one, for right now... #}
            {% set child_datatype = theme_datatype.dataType %}

            {# locate the child datatype's id #}
            {% set child_datatype_id = '' %}
            {% for c_dt_id, c_dt in child_datatype %}
                {% set child_datatype_id = c_dt_id %}
            {% endfor %}

            {% if child_datatype_id != '' %}
                {# locate the master theme id for this child datatype #}
                {% set child_theme_id = '' %}
                {% for t_id, t in child_datatype[ child_datatype_id ]['themes'] %}
                    {% if t['themeType'] == 'master' %}
                        {% set child_theme_id = t['id'] %}
                    {% endif %}
                {% endfor %}

                {# pass all child datarecords of this child datatype to datarecord_childtype.json.twig at once #}
                {% if datarecord['children'][ child_datatype_id ] is defined and theme_datatype.is_link == 0 %}
                    {% set datarecord_array = datarecord['children'][ child_datatype_id ] %}
                    {% set is_top_level = 0 %}

                    {# using macro on purpose #}
                    {% import "ODRAdminBundle:XMLExport:datarecord_childtype.xml.twig" as mychildform %}
                    {% set content = mychildform.input(child_datatype, datarecord_array, child_theme_id, child_datatype_id, datarecord.id, is_top_level, theme_datatype.is_link, using_metadata, baseurl, version) %}

                    {% if "<" in content|trim %}
                        {% if version == 'v1' %}
                            <database_{{ child_datatype_id }}>
                                <database_name>{{ child_datatype[child_datatype_id].dataTypeMeta.shortName|xml }}</database_name>
                        {% elseif version == 'v2' %}
                            <{{ child_datatype[child_datatype_id].dataTypeMeta.xml_shortName }}>
                        {% endif %}

                        {{ content }}

                        {% if version == 'v1' %}
                            </database_{{ child_datatype_id }}>
                        {% elseif version == 'v2' %}
                            </{{ child_datatype[child_datatype_id].dataTypeMeta.xml_shortName }}>
                        {% endif %}

                    {% endif %}

                {% endif %}
            {% endif %}
        {% endfor %}
    {% endif %}
{% endfor %}
</child_records>

{# describe linked datarecords last #}
<linked_records>
{% for theme_element in theme.themeElements %}
    {% if theme_element.themeDataType is defined %}

        {% for theme_datatype in theme_element.themeDataType %}     {# only ever going to be one, for right now... #}
            {% set child_datatype = theme_datatype.dataType %}

            {# locate the child datatype's id #}
            {% set child_datatype_id = '' %}
            {% for c_dt_id, c_dt in child_datatype %}
                {% set child_datatype_id = c_dt_id %}
            {% endfor %}

            {% if child_datatype_id != '' %}
                {# locate the master theme id for this child datatype #}
                {% set child_theme_id = '' %}
                {% for t_id, t in child_datatype[ child_datatype_id ]['themes'] %}
                    {% if t['themeType'] == 'master' %}
                        {% set child_theme_id = t['id'] %}
                    {% endif %}
                {% endfor %}

                {# pass all child datarecords of this child datatype to datarecord_childtype.json.twig at once #}
                {% if datarecord['children'][ child_datatype_id ] is defined and theme_datatype.is_link == 1 %}
                    {% set datarecord_array = datarecord['children'][ child_datatype_id ] %}
                    {% set is_top_level = 0 %}

                    {# using macro on purpose #}
                    {% import "ODRAdminBundle:XMLExport:datarecord_childtype.xml.twig" as mychildform %}
                    {% set content = mychildform.input(child_datatype, datarecord_array, child_theme_id, child_datatype_id, datarecord.id, is_top_level, theme_datatype.is_link, using_metadata, baseurl, version) %}

                    {% if "<" in content|trim %}
                        {% if version == 'v1' %}
                            <database_{{ child_datatype_id }}>
                                <database_name>{{ child_datatype[child_datatype_id].dataTypeMeta.shortName|xml }}</database_name>
                        {% elseif version == 'v2' %}
                            <{{ child_datatype[child_datatype_id].dataTypeMeta.xml_shortName }}>
                        {% endif %}

                        {{ content }}

                        {% if version == 'v1' %}
                            </database_{{ child_datatype_id }}>
                        {% elseif version == 'v2' %}
                            </{{ child_datatype[child_datatype_id].dataTypeMeta.xml_shortName }}>
                        {% endif %}

                    {% endif %}

                {% endif %}
            {% endif %}
        {% endfor %}
    {% endif %}
{% endfor %}
</linked_records>

{% endspaceless %}
