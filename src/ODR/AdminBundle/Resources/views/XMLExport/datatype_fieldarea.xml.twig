{% spaceless %}
    
{% set datatype = datatype_array[target_datatype_id] %}
{% set theme = theme_array[datatype.id] %}

{# describe datafields first #}
<fields>
{% for theme_element in theme.themeElements %}
    {% if theme_element.themeDataFields is defined %}

        {% for theme_datafield in theme_element.themeDataFields %}
            {% if theme_datafield.dataField is defined %}
                {% set datafield_id = theme_datafield.dataField.id %}

                {# intentionally ignoring the 'hidden' property #}
                {% if datatype['dataFields'][datafield_id] is defined %}
                    {% set datafield = datatype['dataFields'][datafield_id] %}

                    {% if datafield.dataFieldMeta.fieldType.typeName != "Markdown" %}
                        {% include 'ODRAdminBundle:XMLExport:datatype_datafield.xml.twig' with {
                            'datafield': datafield,

                            'is_link': is_link,

                            'using_metadata': using_metadata,
                            'baseurl': baseurl,
                            'version': version,
                        } %}
                    {% endif %}
                {% endif %}
            {% endif %}
        {% endfor %}
    {% endif %}
{% endfor %}
</fields>

{# describe child datatypes next #}
<child_databases>
{% for theme_element in theme.themeElements %}
    {% if theme_element.themeDataType is defined %}

        {# should only ever going to be a single child datatype, but keep the loop incase that changes in the future #}
        {% for theme_datatype in theme_element.themeDataType %}
            {% set child_datatype_id = theme_datatype.dataType.id %}

            {# due to filtering, this entry in the theme array isn't guaranteed to exist in the datatype array... #}
            {% if datatype['descendants'][child_datatype_id] is defined %}
                {% set child_datatype = datatype['descendants'][child_datatype_id]['datatype'] %}

                {# only want to do child datatypes in this block #}
                {% if theme_datatype.is_link == 0 %}
                    {% set is_top_level = 0 %}

                    {# using macro on purpose #}
                    {% import "ODRAdminBundle:XMLExport:datatype_childtype.xml.twig" as mychildform %}
                    {% set content = mychildform.input(child_datatype, theme_array, child_datatype_id, is_top_level, theme_datatype.is_link, using_metadata, baseurl, version) %}

                    {% if "<" in content|trim %}
                        {{ content }}
                    {% endif %}

                {% endif %}
            {% endif %}
        {% endfor %}
    {% endif %}
{% endfor %}
</child_databases>

{# describe linked datatypes last #}
<linked_databases>
{% for theme_element in theme.themeElements %}
    {% if theme_element.themeDataType is defined %}

        {# should only ever going to be a single child datatype, but keep the loop incase that changes in the future #}
        {% for theme_datatype in theme_element.themeDataType %}
            {% set child_datatype_id = theme_datatype.dataType.id %}

            {# due to filtering, this entry in the theme array isn't guaranteed to exist in the datatype array... #}
            {% if datatype['descendants'][child_datatype_id] is defined %}
                {% set child_datatype = datatype['descendants'][child_datatype_id]['datatype'] %}

                {# only want to do linked datatypes in this block #}
                {% if theme_datatype.is_link == 1 %}
                    {% set is_top_level = 0 %}

                    {# using macro on purpose #}
                    {% import "ODRAdminBundle:XMLExport:datatype_childtype.xml.twig" as mychildform %}
                    {% set content = mychildform.input(child_datatype, theme_array, child_datatype_id, is_top_level, theme_datatype.is_link, using_metadata, baseurl, version) %}

                    {% if "<" in content|trim %}
                        {{ content }}
                    {% endif %}

                {% endif %}
            {% endif %}
        {% endfor %}
    {% endif %}
{% endfor %}
</linked_databases>

{% endspaceless %}
