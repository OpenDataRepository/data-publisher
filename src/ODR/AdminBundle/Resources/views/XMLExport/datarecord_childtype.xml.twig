{% macro input(datatype_array, datarecord_array, theme_array, target_datatype_id, parent_datarecord_id, target_theme_id, is_top_level, is_link, using_metadata, baseurl, version) %}

{% spaceless %}

{% set datatype = datatype_array[target_datatype_id] %}
{% set theme = theme_array[target_theme_id] %}
{% set render_plugin = datatype.dataTypeMeta.renderPlugin %}

{# all lists of datarecords are wrapped...top-level wrapper taken care of in datarecord_ajax.xml.twig #}
{% if is_top_level == 0 %}
<records>
{% endif %}

{% for dr_id, datarecord in datarecord_array %}

    {# each datarecord is its own object #}
    <record>

        <internal_id>{{ datarecord.id }}</internal_id>
        <unique_id>{{ datarecord.unique_id }}</unique_id>
        <external_id>{{ datarecord.externalIdField_value|xml }}</external_id>
        <record_name>{{ datarecord.nameField_value|xml }}</record_name>

        <datatype_uuid>{{ datatype.unique_id }}</datatype_uuid>
        {% set master_datatype_unique_id = "" %}
        {% if datatype.masterDataType is not null %}
            {% set master_datatype_unique_id = datatype.masterDataType.unique_id %}
        {% endif %}
        <template_uuid>{{ master_datatype_unique_id }}</template_uuid>

        {% set metadata_datatype_unique_id = "" %}
        {% if datatype.metadata_datatype is not null %}
            {% set metadata_datatype_unique_id = datatype.metadata_datatype.unique_id %}
        {% endif %}
        <metadata_uuid>{{ metadata_datatype_unique_id }}</metadata_uuid>

        {% set metadata_for_unique_id = "" %}
        {% if datatype.metadata_for is not null %}
            {% set metadata_for_unique_id = datatype.metadata_for.unique_id %}
        {% endif %}
        <metadata_for_uuid>{{ metadata_for_unique_id }}</metadata_for_uuid>

        {% if is_top_level == 1 %}
         <search_slug>{{ datatype.dataTypeMeta.searchSlug|xml }}</search_slug>
        {% endif %}

    {% if using_metadata == true %}
        {# display metadata and datafields for top-level and child datarecords #}
        <_record_metadata>
            <_create_date>{{ datarecord.created|date('Y-m-d H:i:s') }}</_create_date>
            <_create_auth>{% if datarecord.createdBy != '' %}{{ datarecord.createdBy|user_string|xml }}{% endif %}</_create_auth>
            <_public_date>{{ datarecord.dataRecordMeta.publicDate|date('Y-m-d H:i:s') }}</_public_date>
        </_record_metadata>
    {% endif %}

    {% include 'ODRAdminBundle:XMLExport:datarecord_fieldarea.xml.twig' with {
        'datatype_array': datatype_array,
        'datarecord_array': datarecord_array,
        'theme_array': theme_array,

        'target_datatype_id': target_datatype_id,
        'parent_datarecord_id': parent_datarecord_id,
        'target_datarecord_id': datarecord.id,
        'target_theme_id': target_theme_id,

        'is_top_level': is_top_level,
        'is_link': is_link,

        'using_metadata': using_metadata,
        'baseurl': baseurl,
        'version': version,
    } %}

    {# each datarecord is its own object #}
    </record>

{% endfor %}

{# all lists of datarecords are wrapped...top-level wrapper taken care of in datarecord_ajax.xml.twig #}
{% if is_top_level == 0 %}
</records>
{% endif %}

{% endspaceless %}

{% endmacro %}
