{% spaceless %}

{% set datafield_meta = datafield.dataFieldMeta %}

{% set field_typename = datafield_meta.fieldType.typeName %}
{% set field_typeclass = datafield_meta.fieldType.typeClass %}

{% set datarecordfield = '' %}
{% set valuefield = '' %}
{% set valuefield_value = '' %}
{% if datarecord.dataRecordFields[ datafield.id ] is defined %}
    {% set datarecordfield = datarecord.dataRecordFields[ datafield.id ] %}

    {% if field_typename == "Boolean" %}
        {% set valuefield = datarecordfield.boolean[0] %}
        {% set valuefield_value = valuefield.value %}
    {% elseif field_typename == "File" %}
        {% set valuefield = datarecordfield.file %}
    {% elseif field_typename == "Image" %}
        {% set valuefield = datarecordfield.image %}
    {% elseif field_typename == "Decimal" %}
        {% set valuefield = datarecordfield.decimalValue[0] %}
        {% set valuefield_value = valuefield.value %}
    {% elseif field_typename == "Integer" %}
        {% set valuefield = datarecordfield.integerValue[0] %}
        {% set valuefield_value = valuefield.value %}
    {% elseif field_typename == "Paragraph Text" %}
        {% set valuefield = datarecordfield.longText[0] %}
        {% set valuefield_value = valuefield.value %}
    {% elseif field_typename == "Long Text" %}
        {% set valuefield = datarecordfield.longVarchar[0] %}
        {% set valuefield_value = valuefield.value %}
    {% elseif field_typename == "Medium Text" %}
        {% set valuefield = datarecordfield.mediumVarchar[0] %}
        {% set valuefield_value = valuefield.value %}
    {% elseif field_typeclass == "Radio" %}
        {% set valuefield = datarecordfield.radioSelection %}
    {% elseif field_typename == "Short Text" %}
        {% set valuefield = datarecordfield.shortVarchar[0] %}
        {% set valuefield_value = valuefield.value %}
    {% elseif field_typename == "DateTime" %}
        {% set valuefield = datarecordfield.datetimeValue[0] %}
        {% set valuefield_value = valuefield.value %}
    {% elseif field_typename == "Markdown" %}
        {% set valuefield = '' %}
    {% endif %}

{% endif %}

{% if valuefield == '' and (field_typename == 'File' or field_typename == 'Image' or field_typeclass == 'Radio') %}
    {% set valuefield = [] %}
{% endif %}


{% set tag_start = '' %}
{% set tag_end = '' %}
{% if version == 'v1' %}
    {% set tag_start = '<field_' ~ datafield.id ~ '><field_name>' ~ datafield_meta.fieldName|xml|raw ~ '</field_name>' %}
    {% set tag_end = '</field_' ~ datafield.id ~ '>' %}
{% elseif version == 'v2' %}
    {% set tag_start = '<' ~ datafield_meta.xml_fieldName ~ '>' %}
    {% set tag_end = '</' ~ datafield_meta.xml_fieldName ~ '>' %}
{% endif %}

{{ tag_start|raw }}
    <id>{{ datafield.id }}</id>
    <description>{{ datafield_meta.description|xml|raw }}</description>
    <fieldtype>{{ field_typename }}</fieldtype>
    <field_uuid>{{ datafield.fieldUuid }}</field_uuid>
    <template_field_uuid>{{ datafield.templateFieldUuid }}</template_field_uuid>
    <updated_at>{{ datafield_meta.updated|date('Y-m-d H:i:s') }}</updated_at>    {# TODO - should this be controlled by using_metadata? #}


{% if field_typename == "File" %}
    {% for file in valuefield %}
        {% set file_meta = file.fileMeta %}

        <files>
            <id>{{ file.id }}</id>
            <original_name>{% if file_meta.originalFileName != null %}{{ file_meta.originalFileName|xml|raw }}{% else %}File_{{ file.id }}{% endif %}</original_name>
            <href>{{ baseurl ~ path('odr_file_download', {'file_id': file.id}) }}</href>
            {#<caption></caption>#}
            {#<checksum>{{ file.getoriginalchecksum }}</checksum>#}

            {% if using_metadata == true %}
            <_file_metadata>
                <_external_id>{{ file_meta.external_id }}</_external_id>
                <_create_date>{{ file.created|date('Y-m-d H:i:s') }}</_create_date>
                <_create_auth>{% if file.createdBy != '' %}{{ file.createdBy|user_string }}{% endif %}</_create_auth>
                <_public_date>{{ file_meta.publicDate|date('Y-m-d H:i:s') }}</_public_date>
            </_file_metadata>
            {% endif %}

        </files>
    {% endfor %}

{% elseif field_typename == "Image" %}
    {% for image in valuefield %}
        {% set oimage = image.parent %}
        {% set image_ext = oimage.ext %}

        {% set oimage_meta = oimage.imageMeta %}
        {% set image_caption = oimage_meta.caption %}
        {% set image_filename = oimage_meta.originalFileName %}

        <images>
            <id>{{ oimage.id }}</id>
            <original_name>{% if image_filename != '' %}{{ image_filename|xml|raw }}{% else %}Image_{{ oimage.id }}{% endif %}</original_name>
            <href>{{ baseurl ~ path('odr_image_download', {'image_id': oimage.id}) }}</href>
            <caption>{{ image_caption|xml|raw }}</caption>
            {#<checksum>{{ oimage.getoriginalchecksum }}</checksum>#}

            {% if using_metadata == true %}
            <_image_metadata>
                <_external_id>{{ oimage_meta.external_id }}</_external_id>
                <_create_date>{{ oimage.created|date('Y-m-d H:i:s') }}</_create_date>
                <_create_auth>{% if oimage.createdBy != '' %}{{ oimage.createdBy|user_string }}{% endif %}</_create_auth>
                <_public_date>{{ oimage_meta.publicDate|date('Y-m-d H:i:s') }}</_public_date>
                <_display_order>{{ oimage_meta.displayorder}}</_display_order>
            </_image_metadata>
            {% endif %}
        </images>
    {% endfor %}

{% elseif field_typename == "Single Radio" or field_typename == "Multiple Radio" or field_typename == "Single Select" or field_typename == "Multiple Select" %}
    {% if datafield.radioOptions is defined %}
        <value>
        {% for radio_option in datafield.radioOptions %}
            {% set is_selected = 0 %}
            {% if datarecordfield.radioSelection[ radio_option.id ] is defined %}
                {% set is_selected = datarecordfield.radioSelection[ radio_option.id ].selected %}
            {% endif %}

            {% set radio_option_meta = radio_option.radioOptionMeta %}

            {% if is_selected == 1 %}

                {% set radio_tag_start = '' %}
                {% set radio_tag_end = '' %}
                {% if version == 'v1' %}
                    {% set radio_tag_start = '<radio_option_' ~ radio_option.id ~ '><name>' ~ radio_option_meta.optionName|xml ~'</name>' %}
                    {% set radio_tag_end = '</radio_option_' ~ radio_option.id ~ '>' %}
                {% elseif version == 'v2' %}
                    {% set radio_tag_start = '<' ~ radio_option_meta.xml_fieldName ~ '>' %}
                    {% set radio_tag_end = '</' ~ radio_option_meta.xml_fieldName ~ '>' %}
                {% endif %}

                {{ radio_tag_start|raw }}
                    <id>{{ radio_option.id }}</id>
                    <selected>1</selected>
                    <template_radio_option_uuid>{{ radio_option.radioOptionUuid }}</template_radio_option_uuid>
                    <updated_at>{{ radio_option_meta.updated|date('Y-m-d H:i:s') }}</updated_at>    {# TODO - should this be controlled by using_metadata? #}
                {{ radio_tag_end|raw }}

            {% endif %}
        {% endfor %}
        </value>
    {% endif %}

{% elseif field_typename == "Tags" %}
    {% include 'ODRAdminBundle:XMLExport:datarecord_tag_wrapper.xml.twig' with {
        'datafield': datafield,
        'drf': datarecordfield,
    } %}

{% elseif field_typename == "Boolean" %}
    <selected>{% if valuefield_value == 1 %}1{% else %}0{% endif %}</selected>
{% elseif field_typename == "DateTime" %}
    <value>{% if valuefield_value != '' and valuefield_value|date('Y-m-d') != '9999-12-31' %}{{ valuefield_value|date('Y-m-d') }}{% endif %}</value>
{% else %}
    <value>{{ valuefield_value|xml|raw }}</value>
{% endif %}

{{ tag_end|raw }}   {# end of datafield #}

{% endspaceless %}
