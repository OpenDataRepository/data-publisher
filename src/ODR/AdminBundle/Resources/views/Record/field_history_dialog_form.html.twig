{% spaceless %}
    <!-- Field History Dialog Form -->
    <form class="ODRDatafieldHistoryForm pure-form pure-form-aligned" action="{{ path('odr_record_save', {'record_type': record_type, 'datarecord_id': datarecord_id }) }}" method="post" id="DatafieldHistoryForm">
        <input type="hidden" name="id" value="{{ field_id }}" />
        <input type="hidden" name="ObjType" value="{{ record_type }}" />

        {{ form_errors(form.createdBy) }}
        {{ form_widget(form.createdBy) }}
        {{ form_errors(form.updatedBy) }}
        {{ form_widget(form.updatedBy) }}

        {{ form_errors(form._token) }}
        {{ form_widget(form._token) }}

        {{ form_errors(form.data_field) }}
        {{ form_widget(form.data_field) }}
        {{ form_errors(form.field_type) }}
        {{ form_widget(form.field_type) }}
        {{ form_errors(form.data_record) }}
        {{ form_widget(form.data_record) }}
        {{ form_errors(form.data_record_fields) }}
        {{ form_widget(form.data_record_fields) }}

        <input type="hidden" value="" data-error-type="inline" class="required" required="required" name="{{ record_type }}Form[value]" id="{{ record_type }}Form_value" />

        <fieldset>
            <div class="pure-control-group" id="field_history_table_container" style="overflow: auto; max-height: 500px;">
                <table class="pure-table pure-table-bordered pure-table-striped">
                    <thead><tr>
                        <th>ID</th>
                        <th>Version</th>
                        <th>Updated At</th>
                        <th>Updated By</th>
                        <th>Value</th>
                        <th></th>
                    </tr></thead>
                    <tbody>
                    {% set latest_version = 0 %}
                    {% for log_entry in log_entries %}
                        {% if log_entry.version > latest_version %}
                            {% set latest_version = log_entry.version %}
                        {% endif %}
                    {% endfor %}
                    {% for log_entry in log_entries %}
                        <tr>
                            <td class="center">{{ log_entry.id }}</td>
                            <td class="center">{{ log_entry.version }}</td>
                            <td class="center">{{ log_entry.loggedat|date("Y-m-d H:i:s") }}</td>
                            <td class="center">{% if log_entry.user != null %}{{ log_entry.user.getuserextend.firstname }} {{ log_entry.user.getuserextend.lastname }}{% endif %}</td>
                        {% if record_type == "DatetimeValue" %}
                            <td id="version_{{ log_entry.version }}" class="center">{% if log_entry.value == null %}{% else %}{{ log_entry.value }}{% endif %}</td>
                        {% else %}
                            <td id="version_{{ log_entry.version }}" class="center">{{ log_entry.value }}</td>
                        {% endif %}
                            <td id="version_{{ log_entry.version }}_button" class="center"><button class="pure-button pure-button-primary" type="button" onclick="revertTo('version_{{ log_entry.version}}');">Revert</button></td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </fieldset>

    </form>

    <button type="button" class="pure-button ODRCancelButton">Cancel</button>

    <script>
        $(function() {
            $( "#dialog_field_history" ).dialog({
                autoOpen: false,
                modal: true,
                width: 800,
                open: function(){
                    $(this).parent().css('overflow', 'visible');
                    /* $$.utils.forms.resize()*/
                    $("#field_history_table_container").scrollTop(0);
                }
/*
            }).find('button.submit').click(function(){
                var $el = $(this).parents('.ui-dialog-content');
                if ($el.validate().form()) {
                    $el.find('form')[0].reset();
                    $el.dialog('close');
                }
*/
            }).find('.ODRCancelButton').click(function(){
                var $el = $(this).parents('.ui-dialog-content');
                $el.find('form')[0].reset();
                $el.dialog('close');;
            });

            // Init Form
            DatafieldHistoryFormInit();
        });

/*
        $(function() {
            if(typeof(DatafieldHistoryFormInit) !== "undefined") {
                DatafieldHistoryFormInit();
            }
        });
*/
        $(function() {
            // Doesn't make sense to revert to the current version...remove that option
            var element = "version_{{ latest_version }}_button";
            $("#" + element).remove();
        });

        function revertTo(id) {
            if ( confirm("Are you certain you want to revert back to this value?") ) {
                var previous_value = $("#" + id).html();

                var element = "{{ record_type }}Form_value";
                $("#DatafieldHistoryForm > #" + element).val(previous_value);

                if ( "{{ record_type }}" == "DatetimeValue" )
                    $("#EditDataRecordFieldsForm_{{ data_record_field_id }} .ODRDatePicker").datepicker( "setDate", previous_value );
                else
                    $("#EditDataRecordFieldsForm_{{ data_record_field_id }} #" + element).val(previous_value);

                var $el = $('#dialog_field_history');
                if ($el.validate().form()) {
                    $("#DatafieldHistoryForm").submit();
    
                    $el.find('form')[0].reset();
                    $el.dialog('close');
                }
            }
        }
    </script>
{% endspaceless %}
