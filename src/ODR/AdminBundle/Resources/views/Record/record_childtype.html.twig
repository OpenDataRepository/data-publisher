{#{% macro input(datatype_tree, datarecord_tree, theme, datatype_permissions, datafield_permissions) %}#}
{% spaceless %}

{#{% set datatype = datatype_tree.datatype %}#}
{% set datatype = datatype_array[target_datatype_id] %}

{% set can_edit_record = 0 %}
{% set can_add_record = 0 %}
{% set can_delete_record = 0 %}
{% if datatype_permissions[ datatype.id ] is defined and datatype_permissions[ datatype.id ][ 'edit' ] is defined %}
    {% set can_edit_record = 1 %}
{% endif %}
{% if datatype_permissions[ datatype.id ] is defined and datatype_permissions[ datatype.id ][ 'add' ] is defined %}
    {% set can_add_record = 1 %}
{% endif %}
{% if datatype_permissions[ datatype.id ] is defined and datatype_permissions[ datatype.id ][ 'delete' ] is defined %}
    {% set can_delete_record = 1 %}
{% endif %}

<!-- Child Types -->
<div class="ODRDataType pure-u-1" id="DataType_{{ datatype.id }}" {#rel="{{ datatype_tree.theme_datatype.id }}"#}>

    {#{% include 'ODRAdminBundle:Default:accordion_header.html.twig' with {'datatype_tree': datatype_tree, 'datarecord_tree': datarecord_tree, 'public_only': false} %}#}
    {% include 'ODRAdminBundle:Default:fieldarea_header.html.twig' with {
        'datatype_array': datatype_array,
        'datarecord_array': datarecord_array,

        'target_datatype_id': target_datatype_id,
        'parent_datarecord_id': parent_datarecord_id,

        'is_top_level': is_top_level,
        'display_type': display_type
    } %}

{#
    {% for dr_entry in datarecord_tree %}
        {% set datarecord = dr_entry.datarecord %}
#}
    {% for dr_id, datarecord in datarecord_array %}
{#
----------</br>
datarecord: {{ datarecord.id }}...datatype {{ datarecord.dataType.id }}</br>
parent: {{ datarecord.parent.id }}</br>
grandparent: {{ datarecord.grandparent.id }}</br>
</br>
parent_datarecord_id: {{ parent_datarecord_id }}</br>
target_datatype_id: {{ target_datatype_id }}</br>
</br>
is_top_level: {{ is_top_level }}</br>
is_link: {{ is_link }}</br>
display_type: {{ display_type }}</br>
----------</br>
#}
        {% if (is_link == 1 or datarecord.parent.id == parent_datarecord_id) and datarecord.dataType.id == target_datatype_id %}

            {% include 'ODRAdminBundle:Record:accordion_header.html.twig' with {
                'datarecord': datarecord,
                'datatype': datatype,

                'can_add_record': can_add_record,
                'can_edit_record': can_edit_record,
                'can_delete_record': can_delete_record,

                'is_top_level': is_top_level,
                'display_type': display_type
            } %}

            <div class="ODRFieldArea accordion-content pure-u-1" id="FieldArea_{{ datarecord.id }}">
                {% include 'ODRAdminBundle:Record:record_fields.html.twig' with {
                    'datatype_array': datatype_array,
                    'datarecord_array': datarecord_array,

                    'target_datatype_id': target_datatype_id,
                    'parent_datarecord_id': parent_datarecord_id,
                    'target_datarecord_id': datarecord.id,
                    'theme_id': theme_id,

                    'datatype_permissions': datatype_permissions,
                    'datafield_permissions': datafield_permissions,

                    'is_top_level': is_top_level,
                    'is_link': is_link
                } %}
            </div><!-- End of #FieldArea_{{ datarecord.id }} -->

        {% endif %}
    {% endfor %}


    {#{% include 'ODRAdminBundle:Default:accordion_footer.html.twig' with {'childtype': datatype } %}#}
    {% include 'ODRAdminBundle:Default:fieldarea_footer.html.twig' with {'display_type': display_type } %}

</div><!-- End of #DataType_{{ datatype.id }} -->

{% endspaceless %}
{#{% endmacro %}#}
