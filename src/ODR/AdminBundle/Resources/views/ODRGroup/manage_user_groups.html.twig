{% spaceless %}

<h2>Group Membership for "{{ target_user.getuserstring }}"</h2>

{% if datatypes|length == 0 %}
    <div class="ODRDatarecordListHeader">No Datatypes exist!</div>
{% else %}
    <div class="pure-u-1-2">
        <table id="ODRDatatypeList" class="display dataTable">
            <thead>
            <tr>
                <th></th>
                <th>Database Name</th>
                <th>User in group?</th>
                <th>Database is public?</th>
                <th></th>
            </tr>
            </thead>
            <tbody>
            {% for dt_id, dt in datatypes %}
                {% set datatype_meta = dt.dataTypeMeta %}
                <tr>
                    <td>
                        <span class="ODRDatatypeInfoDiv">
                            <i class="fa fa-lg fa-info-circle"></i>
                            <span class="ODRDatatypeInfo">
                                <div>
                                    <b>Created By: </b>{{ dt.createdBy|user_string }}<b> on </b>{{ dt.created|date('Y-m-d') }}
                                </div>
                                <div>
                                    <b>Description: </b>{{ datatype_meta.description }}
                                </div>
                            </span>
                        </span>
                    </td>
                    <td>{{ datatype_meta.shortName }}</td>
                    <td>
                        <i
                            id="in_datatype_{{ dt_id }}_group"
                            class="fa fa-lg{% if user_datatype_group_membership[ dt_id ] is defined %} fa-check{% endif %} Cursor ODRGroupListCheckbox"
                        >
                            <span class="ODRHidden">{% if user_datatype_group_membership[ dt_id ] is defined %}1{% else %}0{% endif %}</span>
                        </i>
                    </td>
                    <td>
                    {% if datatype_meta.publicDate|is_public %}
                        <i class="fa fa-lg fa-check Cursor ODRGroupListCheckbox"></i>
                    {% endif %}
                    </td>
                    <td id="ODRDatatype_{{ dt_id }}_arrow" class="Pointer ODRListExpand">
                        <i class="fa fa-lg fa-caret-down ODRGrayIcon" rel="{{ dt_id }}"></i>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="pure-u-1-24"></div>

    {% for dt_id, dt in datatypes %}
        {% set datatype_meta = dt.dataTypeMeta %}

        <div id="datatype_groups_{{ dt_id }}" class="ODRGroupList pure-u-11-24" rel="{{ dt_id }}">
            <div class="pure-u-1 ODRManageGroupsHeader">Default Groups for "{{ datatype_meta.shortName }}"</div>

            <div class="pure-u-1">
                {# print out the four default groups across the top #}
                {% set group_id = dt['groups']['view_only']['id'] %}
                <span class="pure-u-1-4 Cursor"  title="{{ dt['groups']['view_only']['groupMeta']['groupDescription'] }}">
                    <input
                        type="checkbox"
                        id="checkbox_{{ target_user.id }}_{{ group_id }}"
                        class="ODRDefaultGroupCheckbox ODRGroupCheckbox"
                        {% if user_group_list[group_id] is defined %}checked{% endif %}
                    />
                    <span class="ODRGroupName">View Only</span>
                </span>

                {% set group_id = dt['groups']['view_all']['id'] %}
                <span class="pure-u-1-4 Cursor"  title="{{ dt['groups']['view_all']['groupMeta']['groupDescription'] }}">
                    <input
                        type="checkbox"
                        id="checkbox_{{ target_user.id }}_{{ group_id }}"
                        class="ODRDefaultGroupCheckbox ODRGroupCheckbox"
                        {% if user_group_list[group_id] is defined %}checked{% endif %}
                    />
                    <span class="ODRGroupName">View All</span>
                </span>

                {% set group_id = dt['groups']['edit_all']['id'] %}
                <span class="pure-u-1-4 Cursor"  title="{{ dt['groups']['edit_all']['groupMeta']['groupDescription'] }}">
                    <input
                        type="checkbox"
                        id="checkbox_{{ target_user.id }}_{{ group_id }}"
                        class="ODRDefaultGroupCheckbox ODRGroupCheckbox"
                        {% if user_group_list[group_id] is defined %}checked{% endif %}
                    />
                    <span class="ODRGroupName">Edit All</span>
                </span>

                {% set group_id = dt['groups']['admin']['id'] %}
                <span class="pure-u-1-4 Cursor" title="{{ dt['groups']['admin']['groupMeta']['groupDescription'] }}">
                    <input
                        type="checkbox"
                        id="checkbox_{{ target_user.id }}_{{ group_id }}"
                        class="ODRDefaultGroupCheckbox ODRGroupCheckbox"
                        {% if user_group_list[group_id] is defined %}checked{% endif %}
                    />
                    <span class="ODRGroupName">Admin</span>
                </span>
            </div>

            <div class="pure-u-1 ODRManageGroupsHeader">Custom Groups for "{{ datatype_meta.shortName }}"</div>
            <div class="pure-u-1" style="margin-bottom:15px;">
                {# print out the remaining non-default groups as a list #}
                {% for group in datatypes[dt_id]['groups'] %}
                    {% if group.purpose == "" %}
                        <div class="pure-u-1">
                            <span class="ODRDatatypeInfoDiv">
                                <i class="fa fa-lg fa-info-circle"></i>
                                <span class="ODRDatatypeInfo">
                                    <div>
                                        <b>Created By: </b>{{ group.createdBy|user_string }}<b> on </b>{{ group.created|date('Y-m-d') }}
                                    </div>
                                    <div>
                                        <b>Description: </b>{{ group.groupMeta.groupDescription }}
                                    </div>
                                </span>
                            </span>
                            <span class="ODRGroupName">
                                <input
                                    type="checkbox"
                                    id="checkbox_{{ target_user.id }}_{{ group['id'] }}"
                                    class="ODRGroupCheckbox"
                                    {% if user_group_list[ group['id'] ] is defined %}checked{% endif %}
                                />
                            </span>
                            <span class="ODRGroupName Cursor">
                                {{ group.groupMeta.groupName }}
                            </span>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>

            <button class="pure-button ODRGroupEdit" title="Edit Groups for this Datatype">Edit Groups for "{{ datatype_meta.shortName }}"</button>
            <button class="pure-button ODREffectivePermissions" rel="{{ target_user.id }}" title="Displays an interface showing what this user would see if he attempted to view this Datatype">View User's Effective Permissions</button>
        </div>
    {% endfor %}

{% endif %}

<script>
    function notifySaved() {
        $.jGrowl('SAVED');
    }

    $(function() {
        disableSearchSidebar();    {# defined in ODRAdminBundle:Default:common_js.html.twig #}

        $("#ODRDatatypeList").dataTable({
            "paging": false,
            "info": false,
            "columnDefs": [
                {
                    "targets": [0, 4],
                    "orderable": false,
                    "searchable": false
                }
            ],
            "order": [[1, "asc"]],
            "language": {
                "emptyTable": "No Databases found"
            }
        });

        // Need to ensure that the group list div on the right stays synchronized with the selected
        //  row of the table on the left
        var selected_row = null;

        var table = $("#ODRDatatypeList").DataTable();
        table.on( 'draw.dt', function() {
            // This datatables event is called after the "order" and "search" events have fired,
            //  and the table has been redrawn on the page...this redrawing means the position or
            //  visibility of the group list needs to be updated

            // If the group list div on the right is visible, save which row it's meant for
            var selected_row_id = '';
            if ( selected_row !== null )
                selected_row_id = $(selected_row).attr('id');

            // Iterate over all visible rows, attempting to find the one that is currently selected
            var selected_element = null;
            $(".ODRListExpand:visible").each(function() {
                if ( $(this).children(".fa-caret-right").length > 0 ) {
                    selected_element = $(this);
                }
            });


            if ( selected_row_id !== '' && selected_element === null ) {
                // The group list div is visible but the corresponding row wasn't found, then the
                //  search function has hidden the corresponding row...so hide the group list div
                $(".ODRGroupList").hide();
                selected_row = null;
            }
            else if ( selected_row_id !== '' && selected_element !== null ) {
                // The group list div and its corresponding row are both visible...ensure the group
                //  list div is in a sensible place relative to its corresponding row
                openGroupList( $(selected_element) );
            }
            else if ( selected_row_id === '' && selected_element === null ) {
                // Neither the group list div nor its corresponding row are visible...do nothing
            }
            else if ( selected_row_id === '' && selected_element !== null ) {
                // The group list div isn't displayed, but one of the rows is currently "selected"
                //  ...reset the arrows
                $(selected_element).children(".fa-caret-right").each(function() {   // should only return one
                    var row_num = $(this).attr('rel');
                    $("#datatype_groups_" + row_num).hide();

                    $(this).removeClass('fa-caret-right').addClass('fa-caret-down ODRGrayIcon');
                });
            }
        });

        $("#ODRDatatypeList").removeAttr('style');
        $(".ODRGroupList").hide();

        $(".ODRListExpand").unbind('click').click(function() {
            // If clicking an already open group list, don't run the block that will open it again
            var already_open = false;
            if ( $(this).children("i").hasClass('fa-caret-right') )
                already_open = true;

            // Hide any open group lists and reset the caret that indicates it's open
            $(".ODRListExpand").children(".fa-caret-right").each(function() {   // should only return one
                var row_num = $(this).attr('rel');
                $("#datatype_groups_" + row_num).hide();

                $(this).removeClass('fa-caret-right').addClass('fa-caret-down ODRGrayIcon');
            });

            if ( !already_open ) {
                // If a group list wasn't open...then open it, and mark this row as selected
                openGroupList( $(this) );
                selected_row = $(this);
            }
            else {
                // If a group list was already open, it has since been closed...therefore there's
                //  no selected row right now
                selected_row = null;
            }
        });

        $(".ODRGroupEdit").unbind('click').click(function() {

            var datatype_id = $(this).parent().attr('rel');

            var url = '{{ path('odr_manage_groups', { 'datatype_id': 0 }) }}';
            url = url.substring(0, (url.length - 1));
            url += datatype_id;

//alert(url);
//return;

            UpdateURL(url);
        });

        $(".ODREffectivePermissions").unbind('click').click(function() {

            var datatype_id = $(this).parent().attr('rel');
            var user_id = $(this).attr('rel');

            var url = '{{ path('odr_view_effective_permissions', { 'user_id': 0, 'datatype_id': 0 }) }}';
            url = url.substring(0, (url.length - 3));
            url += user_id + '/' + datatype_id;

//alert(url);
//return;

            UpdateURL(url);
        });

        $(".ODRGroupCheckbox").unbind('click').click(function() {

            var id_data = $(this).attr('id').split(/_/);
            var user_id = id_data[1];
            var group_id = id_data[2];

            var element = $(this);
            var value = 0;
            if ( $(element).is(':checked') )
                value = 1;

            var url = '{{ path('odr_change_user_group', {'user_id': 0, 'group_id': 0, 'value': 0}) }}';
            url = url.substring(0, (url.length - 5));
            url += user_id + '/' + group_id + '/' + value;

//alert(url);
//return;

            $.ajax({
                cache: false,
                type: 'GET',
                url: url,
                dataType: 'json',
                success: function(data, textStatus, jqXHR) {
                    if ( value === 1 && $(element).hasClass('ODRDefaultGroupCheckbox') ) {
                        // Set all other default group checkboxes to false
                        $(element).parent().parent().find('.ODRDefaultGroupCheckbox').each(function() {
                            $(this).prop('checked', false);
                        });
                        // Set this specific group checkbox to true
                        $(element).prop('checked', true);
                    }

                    var target = $("#in_datatype_" + data.datatype_id + "_group");
                    if (data.in_datatype_group === 1) {
                        $(target).addClass('fa-check');
                        $(target).children('span').html(1);
                    }
                    else {
                        $(target).removeClass('fa-check');
                        $(target).children('span').html(0);
                    }

                    notifySaved();
                    // Delete the sort order that datatables cached so sorting works afterwards
                    $("#ODRDatatypeList").DataTable().rows().invalidate();
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    // Change the checkbox that triggered this event back to its original state
                    if ( value === 1 )
                        $(element).prop('checked', false);
                    else
                        $(element).prop('checked', true);
                },
                complete: function (jqXHR, textStatus) {
                    // Get the xdebugToken from response headers
                    var xdebugToken = jqXHR.getResponseHeader('X-Debug-Token');

                    // If the Sfjs object exists
                    if (typeof Sfjs !== "undefined") {
                        // Grab the toolbar element
                        var currentElement = $('.sf-toolbar')[0];

                        // Load the data of the given xdebug token into the current toolbar wrapper
                        Sfjs.load(currentElement.id, '/app_dev.php/_wdt/' + xdebugToken);
                    }
                }
            });
        });
    });

    function openGroupList(element) {
        // Going to need these three numbers to determine where to put the group list div
        var table_offset = $("#ODRDatatypeList_wrapper").offset().top;
        var table_height = $("#ODRDatatypeList_wrapper").height();
        var offset_top = $(element).parent().offset().top - 15;

        // Open the selected datarecord list
        $(element).children("i").each(function() {     // should only return one
            var row_num = $(this).attr('rel');
            $(this).removeClass('fa-caret-down ODRGrayIcon').addClass('fa-caret-right');

            // Determine height of the div displaying this datatype's groups
            var group_div = $("#datatype_groups_" + row_num);
            $(group_div).show();
            var group_div_height = $(group_div).height();

            var final_offset = offset_top;

            // If the height of the group div is less than the height of the datatype list table...
            if (table_height > group_div_height) {
                // ...adjust the offset so the bottom of the group div isn't below the bottom of the datatype list table
                if ((final_offset + group_div_height) > (table_offset + table_height))
                    final_offset = (table_offset + table_height) - group_div_height;
            }

            $(group_div).offset({ top: final_offset });
        });
    }
</script>
{% endspaceless %}
