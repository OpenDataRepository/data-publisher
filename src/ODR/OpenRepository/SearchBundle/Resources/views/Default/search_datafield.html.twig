{% spaceless %}

{% set datatype_id = datatype.id %}
{% set datafield_id = datafield.id %}

{% set datafield_meta = datafield.dataFieldMeta %}
{% set fieldname = datafield_meta['fieldName'] %}
{% set description = datafield_meta['description'] %}
{% set field_typename = datafield_meta['fieldType']['typeName'] %}
{% set field_typeclass = datafield_meta['fieldType']['typeClass'] %}

{% set preset_value = '' %}
{% if search_params[datafield_id] is defined %}
    {# doesn't make sense for radio/tags #}
    {% set preset_value = search_params[datafield_id] %}
{% endif %}

{% set rendering_options = {'is_datatype_admin': false, 'context': 'search'} %}
{% set render_plugin_instance = null %}
{% set can_execute_plugin = false %}

{% for rpi_num,rpi in datafield.renderPluginInstances %}
    {% if rpi.renderPlugin.overrideSearch == true and rpi.renderPlugin.active and rpi.renderPlugin.render != 'false' %}
        {% set can_execute_plugin = rpi|can_execute_search_plugin(datatype, datafield, rendering_options) %}

        {# Only want to save the render_plugin_instance if it's render-able #}
        {% if can_execute_plugin %}
            {% set render_plugin_instance = rpi %}
        {% endif %}
    {% endif %}
{% endfor %}

{% set content = '' %}
{% if can_execute_plugin %}
    {% set content = render_plugin_instance|search_plugin(datatype, datafield, preset_value, rendering_options) %}
{% endif %}

{% if can_execute_plugin and content|length > 0 %}
    {{ content|raw }}
{% else %}
    <span class="pure-u-1">
        <label {% if field_typename != "DateTime" and field_typeclass != "Radio" and field_typeclass != "Tag"%}for="datafield_{{ datafield_id }}"{% endif %}
               class="pure-u-1">

            <span title="{{ description }}">{{ fieldname }}{% if field_typeclass == 'File' or field_typeclass == 'Image'%} filename{% endif %}:</span>
        {% if field_typeclass == "Radio" %}
            <span class="pure-u-1 ODRSelectAll ODRSelectAllOption" rel="{{ datafield_id }}" title="Select all options">
                <span class="ODRTristateCheckbox" rel="multiple">
                    <i class="fa fa-check"></i>
                </span>
            </span>
            <span class="pure-u-1 ODRDeselectAll ODRSelectAllOption" rel="{{ datafield_id }}" title="Deselect all options">
                <span class="ODRTristateCheckbox" rel="multiple">
                    <i class="fa fa-ban"></i>
                </span>
            </span>
            <span class="pure-u-1 ODRClearAll ODRSelectAllOption" rel="{{ datafield_id }}" title="Clear all selections">
                <span class="ODRTristateCheckbox" rel="multiple">
                    <i class="fa"></i>
                </span>
            </span>
        {% endif %}
        {% if field_typeclass == "Radio" or field_typeclass == "Tag" %}
            <input id="df_{{ datafield_id }}_filter" class="ODRSearchDatafieldFilter fa" type="text"
                   title="Filter {{ field_typeclass }} field" rel="{{ field_typeclass }}"
                   placeholder="&#xf002;"    {# use the fa-search icon as a placeholder #}
                   size="15" maxlength="15"
            />
        {% endif %}
        {% if field_typename == "DateTime" %}
            <span id="df_{{ datafield_id }}_clear" class="ODRDatePickerSearch_clear">Clear Dates</span>
        {% endif %}
        </label>
    </span>

    {% if field_typename == "Boolean" %}
        <select class="ODRInput pure-u-1 Pointer" id="datafield_{{ datafield_id }}" name="{{ datafield_id }}" rel="{{ datatype_id }}">
            <option value="">Any</option>
            <option value="0" {% if preset_value == '0' %}selected{% endif %}>Unchecked</option>
            <option value="1" {% if preset_value == '1' %}selected{% endif %}>Checked</option>
        </select>

    {% elseif field_typename == "File" or field_typename == "Image" %}
        {% set can_view_nonpublic_files = false %}
        {% if datatype_permissions[datatype_id] is defined and datatype_permissions[datatype_id]['dr_view'] is defined
            and datafield_permissions[datafield_id] is defined and datafield_permissions[datafield_id]['view'] is defined
        %}
            {% set can_view_nonpublic_files = true %}
        {% endif %}

        <input type="text" class="ODRInput ODRFileDatafieldName pure-u-1" id="datafield_{{ datafield_id }}_fn" name="{{ datafield_id }}" value="{{ preset_value }}" rel="{{ datatype_id }}" title="Search based on the {{ field_typename }}'s filename"/>

        <label class="pure-u-1"></label>
        <select class="ODRInput ODRFileDatafieldExist pure-u-1" id="datafield_{{ datafield_id }}_ex" rel="{{ datatype_id }}" title="Search based on whether this field has any {{ field_typename }}s uploaded or not">
            <option value="">Any</option>
            <option value="1" {% if preset_value != '' and preset_value != '""' %}selected{% endif %}>Has {{ field_typename }}s</option>
            <option value="0" {% if preset_value == '""' %}selected{% endif %}>Does not have {{ field_typename }}s</option>
        </select>

        {# Don't allow users to search on file public status if they can't view non-public files #}
        {% if can_view_nonpublic_files %}
            {% set key = datafield_id ~ '_pub' %}
            {% set value = '' %}
            {% if search_params[key] is defined %}
                {% set value = search_params[key] %}
            {% endif %}
            <label class="pure-u-1" for="{{ datafield_id }}_pub" title="Find {{ field_typename }}s based on public status">{{ fieldname }} Public status:</label>
            <select class="ODRInput pure-u-1 Pointer" id="{{ key }}" name="{{ key }}" rel="{{ datafield_id }}">
                <option id="Option_0" value="">Any</option>
                <option id="Option_nonpublic" value="0" {% if value == '0' %}selected{% endif %}>Non-public</option>
                <option id="Option_public" value="1" {% if value == '1' %}selected{% endif %}>Public</option>
            </select>
        {% endif %}

        {% if datafield_meta.quality_str != '' %}
            {% set key = datafield_id ~ '_qual' %}
            {% set selection = '' %}
            {% if search_params[key] is defined %}
                {% set selection = search_params[key] %}
            {% endif %}

            <label class="pure-u-1" for="{{ key }}" title="Find {{ field_typename }}s based on quality">{{ fieldname }} Quality:</label>
            {% if datafield_meta.quality_str == 'toggle' or datafield_meta.quality_str == 'stars5' %}
                {% set max = 1 %}
                {% if datafield_meta.quality_str == 'stars5' %}
                    {% set max = 5 %}
                {% endif %}

                <select class="ODRInput pure-u-1 Pointer" id="{{ key }}" name="{{ key }}" rel="{{ datafield_id }}">
                    <option id="Option_any" value="">Any</option>
                    {% for i in 0..max %}
                        <option id="Option_{{ i }}" value="{{ i }}" {% if selection != '' and selection == i %}selected{% endif %}>{{ i }}</option>
                    {% endfor %}
                </select>
            {% else %}
                {% set decoded_quality = datafield_meta.quality_str|quality_json_decode %}    {# TODO: should attempt to cache this... #}
                {% if decoded_quality != '' %}
                    <select class="ODRInput pure-u-1 Pointer" id="{{ key }}" name="{{ key }}" rel="{{ datafield_id }}">
                        <option id="Option_any" value="">Any</option>
                        {% for num,label in decoded_quality %}
                            <option value="{{ num }}" {% if selection != '' and selection == num %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                {% endif %}
            {% endif %}
        {% endif %}

    {% elseif field_typename == 'DateTime' %}
        {% set key = datafield_id ~ '_s' %}
        {% set value = '' %}
        {% if search_params[key] is defined %}
            {% set value = search_params[key] %}
        {% endif %}
        <input type="text" class="ODRInput ODRDatePicker pure-u-1 Pointer" id="df_{{ datafield_id }}_start" name="{{ key }}" value="{{ value }}" rel="df_{{ datafield_id }}" title="Find records with a value AFTER this date" />

        {% set key = datafield_id ~ '_e' %}
        {% set value = '' %}
        {% if search_params[key] is defined %}
            {% set value = search_params[key] %}
        {% endif %}
        <label class="pure-u-1"></label>
        <input type="text" class="ODRInput ODRDatePicker pure-u-1 Pointer" id="df_{{ datafield_id }}_end" name="{{ key }}" value="{{ value }}" rel="df_{{ datafield_id }}" title="Find records with a value BEFORE this date" />

    {% elseif field_typeclass == "Radio" %}
        {% set selected_ro_ids = [] %}
        {% set unselected_ro_ids = [] %}
        {% if preset_value != '' %}
            {% set selected_ro_ids = preset_value['selected'] %}
            {% set unselected_ro_ids = preset_value['unselected'] %}
        {% endif %}

        <span class="pure-u-1 ODRRadioSearchDiv ODRSearchScrollbox" id="Input_{{ datafield_id }}" rel="{{ datatype_id }}">
        {% if datafield['radioOptions'] is defined %}
            <input type="hidden" id="datafield_{{ datafield_id }}" name="{{ datafield_id }}" value="" />

            {% for num, radio_option in datafield['radioOptions'] %}
            {% set ro_id = radio_option.id %}
            <label id="Label_{{ ro_id }}" for="RadioOption_{{ ro_id }}" class="ODRRadioLabel pure-u-1">
                <span id="RadioOption_{{ ro_id }}" class="ODRTristateCheckbox" rel="{% if field_typename == "Single Radio" or field_typename == "Single Select" %}single{% else %}multiple{% endif %}">
                    <i class="fa {% if ro_id in selected_ro_ids %}fa-check{% elseif ro_id in unselected_ro_ids %}fa-ban{% endif %}"></i>
                    <input type="hidden" rel="{{ ro_id }}" value="" />
                </span>
                {{ radio_option['radioOptionMeta']['optionName'] }}
            </label>
            {% endfor %}
        {% endif %}
        </span>

    {% elseif field_typeclass == "Tag" %}
        {% set selected_tags = [] %}
        {% set unselected_tags = [] %}
        {% if preset_value != '' %}
            {% set selected_tags = preset_value['selected'] %}
            {% set unselected_tags = preset_value['unselected'] %}
        {% endif %}

        <span class="pure-u-1 ODRTagSearchDiv ODRSearchScrollbox" id="Input_{{ datafield_id }}" rel="{{ datatype_id }}">
        {% if datafield['tags'] is defined %}
            <input type="hidden" class="ODRInput" id="datafield_{{ datafield_id }}" name="{{ datafield_id }}" value="" />

            {% include 'ODROpenRepositorySearchBundle:Default:tag_wrapper.html.twig' with {
                'stacked_tags': datafield['tags'],

                'selected_tags': selected_tags,
                'unselected_tags': unselected_tags,
            } %}
        {% endif %}
        </span>

    {% else %}    {# text/number fieldtypes #}
        <input type="text" class="ODRInput pure-u-1" id="datafield_{{ datafield_id }}" name="{{ datafield_id }}" rel="{{ datatype_id }}" {% if preset_value != '' %}value="{{ preset_value }}"{% endif %}/>
    {% endif %}
{% endif %}

{% endspaceless %}
